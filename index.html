<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Task App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://esm.sh/firebase@10.7.1/app",
        "firebase/auth": "https://esm.sh/firebase@10.7.1/auth",
        "firebase/firestore": "https://esm.sh/firebase@10.7.1/firestore",
        "lucide-react": "https://esm.sh/lucide-react@0.303.0"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: sans-serif; }
        /* Loading spinner styles */
        #root:empty::before {
            content: '注...';
            display: block;
            text-align: center;
            margin-top: 50px;
            font-family: sans-serif;
            font-size: 24px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, 
            setDoc, 
            updateDoc, 
            increment,
            arrayUnion,
            getDoc
        } from 'firebase/firestore';
        import { 
            Check, Star, Trophy, Plus, Minus, X, Sparkles, Utensils, Shirt, Gamepad2, 
            Trash2, Home, Settings, Smile, Heart, Sun, Moon, Music, Book, Bike, 
            Car, Cat, Dog, Flower, Palette, Camera, Upload, Image as ImageIcon, 
            Type, Calendar, Repeat, MoreVertical, RotateCcw, Target, CalendarDays
        } from 'lucide-react';

        // --- YOUR FIREBASE KEYS ---
        const firebaseConfig = {
            apiKey: "AIzaSyCET42vMcj1uC0nMsqsWy2xd-yv1WC7e68",
            authDomain: "family-tasks-ee68f.firebaseapp.com",
            projectId: "family-tasks-ee68f",
            storageBucket: "family-tasks-ee68f.firebasestorage.app",
            messagingSenderId: "579816138584",
            appId: "1:579816138584:web:1b2a3cbf4c5fd00a45e72d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // App ID for data separation (Defaulting to 'family-app' for safety)
        const appId = 'family-app-main'; 

        // --- Configuration Constants ---

        const ICON_MAP = {
            'trophy': Trophy, 'utensils': Utensils, 'shirt': Shirt, 'gamepad': Gamepad2,
            'home': Home, 'star': Star, 'heart': Heart, 'smile': Smile, 'sun': Sun,
            'moon': Moon, 'music': Music, 'book': Book, 'bike': Bike, 'car': Car,
            'cat': Cat, 'dog': Dog, 'flower': Flower, 'camera': Camera, 'sparkles': Sparkles
        };

        const THEMES = [
            { id: 'pink', name: '专', classes: 'bg-pink-100 text-pink-700 border-pink-300', iconBg: 'bg-pink-200', iconText: 'text-pink-600' },
            { id: 'blue', name: '', classes: 'bg-blue-100 text-blue-700 border-blue-300', iconBg: 'bg-blue-200', iconText: 'text-blue-600' },
            { id: 'green', name: '专拽', classes: 'bg-green-100 text-green-700 border-green-300', iconBg: 'bg-green-200', iconText: 'text-green-600' },
            { id: 'purple', name: '住', classes: 'bg-purple-100 text-purple-700 border-purple-300', iconBg: 'bg-purple-200', iconText: 'text-purple-600' },
            { id: 'yellow', name: '爪', classes: 'bg-yellow-100 text-yellow-700 border-yellow-300', iconBg: 'bg-yellow-200', iconText: 'text-yellow-600' },
            { id: 'orange', name: '转', classes: 'bg-orange-100 text-orange-700 border-orange-300', iconBg: 'bg-orange-200', iconText: 'text-orange-600' },
            { id: 'teal', name: '专拽', classes: 'bg-teal-100 text-teal-700 border-teal-300', iconBg: 'bg-teal-200', iconText: 'text-teal-600' },
            { id: 'red', name: '', classes: 'bg-red-100 text-red-700 border-red-300', iconBg: 'bg-red-200', iconText: 'text-red-600' },
        ];

        // Initial default tasks
        const CHILDREN_DEFAULTS = [
            {
                id: 'mushka',
                name: ' 砖拽',
                defaultThemeId: 'yellow',
                defaultIconKey: 'home',
                initialTasks: [{ id: 'def_mushka_1', text: '专爪驻', type: 'daily' }]
            },
            {
                id: 'dvora',
                name: '专 ',
                defaultThemeId: 'pink',
                defaultIconKey: 'utensils',
                initialTasks: [{ id: 'def_dvora_1', text: '  砖砖', type: 'daily' }]
            },
            {
                id: 'rivka',
                name: '专拽',
                defaultThemeId: 'purple',
                defaultIconKey: 'utensils',
                initialTasks: [
                    { id: 'def_rivka_1', text: '驻转 砖', type: 'daily' },
                    { id: 'def_rivka_2', text: '注专 专转 注专', type: 'daily' }
                ]
            },
            {
                id: 'shmuel',
                name: '砖',
                defaultThemeId: 'blue',
                defaultIconKey: 'shirt',
                initialTasks: [
                    { id: 'def_shmuel_1', text: '驻转 转 住驻', type: 'daily' },
                    { id: 'def_shmuel_2', text: '住祝   住', type: 'daily' }
                ]
            },
            {
                id: 'pitzo',
                name: '住祝 爪拽',
                defaultThemeId: 'green',
                defaultIconKey: 'gamepad',
                initialTasks: [
                    { id: 'def_pitzo_1', text: '住祝 砖拽', type: 'daily' },
                    { id: 'def_pitzo_2', text: '住祝 注', type: 'daily' }
                ]
            }
        ];

        const FAMILY_DEFAULT = {
            defaultThemeId: 'yellow',
            defaultIconKey: 'trophy',
            defaultTitle: '爪注 砖驻转',
            defaultTarget: 100
        };

        // Helper to convert number to Hebrew Gematria
        const toHebrewNumeral = (n) => {
            if (!n || n < 1 || n > 31) return n;
            const letters = [
                '', '壮', '壮', '壮', '壮', '壮', '壮', '壮', '壮', '壮', '壮', 
                '状', '状', '状', '状', '状', '状', '状', '状', '状', '壮', 
                '状', '状', '状', '状', '状', '状', '状', '状', '状', '壮', '状'
            ];
            return letters[n] || n;
        };

        // Helper function to compress images
        const resizeImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 300;
                        const MAX_HEIGHT = 300;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // --- Confetti Component ---
        function Confetti({ density = 150 }) {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                
                const updateSize = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                };
                updateSize();
                window.addEventListener('resize', updateSize);

                const colors = ['#FCD34D', '#F87171', '#60A5FA', '#34D399', '#A78BFA', '#F472B6'];
                const particles = Array.from({ length: density }).map(() => ({
                    x: Math.random() * canvas.width,
                    y: -Math.random() * canvas.height,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4,
                    weight: Math.random() * 3 + 2,
                    angle: Math.random() * 360,
                    spin: Math.random() * 5 - 2.5,
                    oscillationSpeed: Math.random() * 0.05 + 0.02
                }));

                let animationId;
                function animate() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles.forEach(p => {
                        p.y += p.weight;
                        p.angle += p.spin;
                        p.x += Math.sin(p.angle * p.oscillationSpeed) * 2;
                        if (p.y > canvas.height) {
                            p.y = -10;
                            p.x = Math.random() * canvas.width;
                        }
                        ctx.save();
                        ctx.translate(p.x, p.y);
                        ctx.rotate(p.angle * Math.PI / 180);
                        ctx.fillStyle = p.color;
                        ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                        ctx.restore();
                    });
                    animationId = requestAnimationFrame(animate);
                }
                animate();
                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', updateSize);
                };
            }, [density]);
            return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-[100]" />;
        }

        function App() {
            const [user, setUser] = useState(null);
            const [points, setPoints] = useState(0);
            const [completedTasks, setCompletedTasks] = useState({}); 
            const [childSettings, setChildSettings] = useState({}); 
            const [familySettings, setFamilySettings] = useState({}); 
            const [tasksData, setTasksData] = useState({});
            
            const [selectedChild, setSelectedChild] = useState(null);
            const [editingChildId, setEditingChildId] = useState(null);
            const [showFamilyEditModal, setShowFamilyEditModal] = useState(false);
            const [showBonusModal, setShowBonusModal] = useState(false);
            const [showWinModal, setShowWinModal] = useState(false);
            const [animationClass, setAnimationClass] = useState('');
            
            const [showConfetti, setShowConfetti] = useState(false);
            const confettiTimeoutRef = useRef(null);
            const longPressTimer = useRef(null);
            const isLongPress = useRef(false);

            const targetPoints = familySettings.targetPoints || FAMILY_DEFAULT.defaultTarget;
            const [currentDate, setCurrentDate] = useState('');
            const [hebrewDate, setHebrewDate] = useState('');

            useEffect(() => {
                const initAuth = async () => {
                    await signInAnonymously(auth);
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                
                const now = new Date();
                setCurrentDate(now.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' }));
                
                try {
                    const parts = new Intl.DateTimeFormat('he-IL', { 
                        calendar: 'hebrew', day: 'numeric', month: 'long', year: 'numeric'
                    }).formatToParts(now);
                    const day = parts.find(p => p.type === 'day')?.value;
                    const month = parts.find(p => p.type === 'month')?.value;
                    const year = parts.find(p => p.type === 'year')?.value;
                    if (day && month && year) {
                        const dayNum = parseInt(day, 10); 
                        const dayHeb = toHebrewNumeral(dayNum);
                        setHebrewDate(`${dayHeb} ${month} ${year}`);
                    }
                } catch (e) {
                    console.log("Hebrew calendar error", e);
                }
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setPoints(Number(data.points) || 0);
                        setCompletedTasks(data.completedTasks || {});
                        setChildSettings(data.childSettings || {});
                        setFamilySettings(data.familySettings || {});
                        setTasksData(data.childTasks || {});
                    } else {
                        setDoc(docRef, { points: 0, completedTasks: {}, childSettings: {}, familySettings: {}, childTasks: {} });
                    }
                }, (error) => {
                    console.error("Error fetching data:", error);
                });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (points >= targetPoints && points > 0) {
                    setShowWinModal(true);
                }
            }, [points, targetPoints]);

            const getTodayKey = () => {
                const d = new Date();
                return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
            };

            const getChildVisuals = (childId) => {
                const childDefault = CHILDREN_DEFAULTS.find(c => c.id === childId);
                const settings = childSettings[childId] || {};
                const themeId = settings.themeId || childDefault.defaultThemeId;
                const theme = THEMES.find(t => t.id === themeId) || THEMES[0];
                const useImage = settings.useImage;
                const image = settings.image;
                const useEmoji = settings.useEmoji;
                const emoji = settings.emoji || '';
                const iconKey = settings.iconKey || childDefault.defaultIconKey;
                const IconComponent = ICON_MAP[iconKey] || Smile;
                const name = settings.name || childDefault.name;
                return { theme, IconComponent, useEmoji, emoji, useImage, image, name };
            };

            const getChildTasks = (childId) => {
                if (tasksData[childId]) {
                    const today = getTodayKey();
                    const dayOfWeek = new Date().getDay(); 
                    return tasksData[childId].filter(t => 
                        t.type === 'daily' || 
                        (t.type === 'one-time' && t.date === today) ||
                        (t.type === 'friday' && dayOfWeek === 5)
                    );
                }
                return CHILDREN_DEFAULTS.find(c => c.id === childId)?.initialTasks || [];
            };

            const getFamilyVisuals = () => {
                const settings = familySettings || {};
                const themeId = settings.themeId || FAMILY_DEFAULT.defaultThemeId;
                const theme = THEMES.find(t => t.id === themeId) || THEMES[0];
                const useImage = settings.useImage;
                const image = settings.image;
                const useEmoji = settings.useEmoji;
                const emoji = settings.emoji || '';
                const iconKey = settings.iconKey || FAMILY_DEFAULT.defaultIconKey;
                const IconComponent = ICON_MAP[iconKey] || Trophy;
                const title = settings.title || FAMILY_DEFAULT.defaultTitle;
                return { theme, IconComponent, useEmoji, emoji, useImage, image, title };
            }

            const triggerConfetti = () => {
                setAnimationClass('scale-110');
                setTimeout(() => setAnimationClass(''), 200);
                setShowConfetti(true);
                if (confettiTimeoutRef.current) clearTimeout(confettiTimeoutRef.current);
                confettiTimeoutRef.current = setTimeout(() => setShowConfetti(false), 3000); 
            };

            const handleTaskToggle = async (childId, taskId) => {
                if (!user) return;
                const taskKey = `${getTodayKey()}_${childId}_${taskId}`;
                const isAlreadyDone = completedTasks[taskKey];
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');

                if (isAlreadyDone) {
                    await updateDoc(docRef, {
                        points: increment(-1),
                        [`completedTasks.${taskKey}`]: false
                    });
                } else {
                    triggerConfetti();
                    await updateDoc(docRef, {
                        points: increment(1),
                        [`completedTasks.${taskKey}`]: true
                    });
                }
            };

            const handleAddTask = async (childId, newTaskText, taskType) => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');
                const currentTasks = tasksData[childId] || CHILDREN_DEFAULTS.find(c => c.id === childId).initialTasks;
                const newTask = {
                    id: `custom_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    text: newTaskText,
                    type: taskType,
                    date: getTodayKey(), 
                    createdAt: Date.now()
                };
                const updatedChildTasks = { ...tasksData, [childId]: [...currentTasks, newTask] };
                await updateDoc(docRef, { childTasks: updatedChildTasks });
            };

            const handleDeleteTask = async (childId, taskId) => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');
                const currentTasks = tasksData[childId] || CHILDREN_DEFAULTS.find(c => c.id === childId).initialTasks;
                const updatedList = currentTasks.filter(t => t.id !== taskId);
                const updatedChildTasks = { ...tasksData, [childId]: updatedList };
                await updateDoc(docRef, { childTasks: updatedChildTasks });
            };

            const handleBonusPoint = async (amount = 1) => {
                if (!user) return;
                triggerConfetti();
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');
                await updateDoc(docRef, { points: increment(amount) });
                setShowBonusModal(false);
            };

            const handleSaveSettings = async (childId, newSettings) => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');
                const updatedChildSettings = { ...childSettings, [childId]: { ...childSettings[childId], ...newSettings } };
                await updateDoc(docRef, { childSettings: updatedChildSettings });
                setEditingChildId(null);
            };

            const handleSaveFamilySettings = async (newSettings) => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');
                await updateDoc(docRef, { familySettings: newSettings });
                setShowFamilyEditModal(false);
            }

            const handleResetPoints = async () => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');
                await updateDoc(docRef, { points: 0 });
                setShowWinModal(false);
            }

            const createLongPressHandlers = (callback, onClick) => {
                return {
                    onMouseDown: () => {
                        isLongPress.current = false;
                        longPressTimer.current = setTimeout(() => {
                            isLongPress.current = true;
                            callback();
                        }, 800);
                    },
                    onMouseUp: (e) => {
                        if (longPressTimer.current) clearTimeout(longPressTimer.current);
                        if (!isLongPress.current && onClick) onClick(e);
                    },
                    onMouseLeave: () => {
                        if (longPressTimer.current) clearTimeout(longPressTimer.current);
                    },
                    onTouchStart: () => {
                        isLongPress.current = false;
                        longPressTimer.current = setTimeout(() => {
                            isLongPress.current = true;
                            callback();
                        }, 800);
                    },
                    onTouchEnd: (e) => {
                        if (longPressTimer.current) clearTimeout(longPressTimer.current);
                        if (isLongPress.current) e.preventDefault(); 
                        if (!isLongPress.current && onClick) onClick(e);
                    }
                };
            };

            const progressPercent = Math.min((points / targetPoints) * 100, 100);
            const familyVisuals = getFamilyVisuals();

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800" dir="rtl">
                    {(showConfetti || showWinModal) && <Confetti density={showWinModal ? 400 : 150} />}

                    <header className="bg-white shadow-lg p-6 sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-3 select-none">
                                <div 
                                    className={`p-3 rounded-full cursor-pointer transition-transform active:scale-95 ${familyVisuals.theme.classes.split(' ')[0]} ${familyVisuals.theme.classes.split(' ')[2].replace('border', 'border-2')}`}
                                    {...createLongPressHandlers(() => setShowFamilyEditModal(true))}
                                >
                                    <div className="w-8 h-8 flex items-center justify-center overflow-hidden rounded-full">
                                        {familyVisuals.useImage && familyVisuals.image ? (
                                            <img src={familyVisuals.image} alt="Family" className="w-full h-full object-cover" />
                                        ) : familyVisuals.useEmoji ? (
                                            <span className="text-2xl leading-none">{familyVisuals.emoji}</span>
                                        ) : (
                                            <familyVisuals.IconComponent className={`w-8 h-8 ${familyVisuals.theme.iconText}`} />
                                        )}
                                    </div>
                                </div>
                                <div>
                                    <h1 
                                        className="text-2xl font-bold text-slate-800 cursor-pointer hover:text-blue-600 transition-colors"
                                        {...createLongPressHandlers(() => setShowFamilyEditModal(true))}
                                        title="爪 专 注专"
                                    >
                                        {familyVisuals.title}
                                    </h1>
                                    <div className="text-slate-500 text-sm flex gap-2">
                                        <span>{currentDate}</span>
                                        {hebrewDate && <span className="border-r border-slate-300 pr-2">{hebrewDate}</span>}
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 w-full md:w-auto md:mx-8">
                                <div className="flex justify-between mb-2 text-lg font-bold">
                                    <span className={`transition-transform duration-300 ${animationClass} text-blue-600`}>
                                        {points} 拽转
                                    </span>
                                    <span className="text-slate-400">注: {targetPoints}</span>
                                </div>
                                <div className="h-6 w-full bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                    <div 
                                        className="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-700 ease-out flex items-center justify-center relative"
                                        style={{ width: `${progressPercent}%` }}
                                    >
                                        {progressPercent > 10 && (
                                            <div className="absolute left-0 top-0 bottom-0 w-full animate-[shimmer_2s_infinite] bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12"></div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <button 
                                onClick={() => setShowBonusModal(true)}
                                className="flex items-center gap-2 bg-gradient-to-r from-orange-400 to-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:shadow-lg transform active:scale-95 transition-all"
                            >
                                <Sparkles className="w-5 h-5" />
                                <span>住</span>
                            </button>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-6">
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mt-4">
                            {CHILDREN_DEFAULTS.map((child) => {
                                const { theme, IconComponent, useEmoji, emoji, useImage, image, name } = getChildVisuals(child.id);
                                const currentTasks = getChildTasks(child.id);
                                return (
                                    <div 
                                        key={child.id}
                                        className={`
                                            group relative 
                                            bg-white rounded-3xl p-6 
                                            border-4 ${theme.classes.split(' ')[2]}
                                            shadow-md hover:shadow-xl hover:-translate-y-2
                                            transition-all duration-300
                                            flex flex-col items-center justify-center gap-4
                                            h-64 select-none
                                        `}
                                        {...createLongPressHandlers(
                                            () => setEditingChildId(child.id), 
                                            () => setSelectedChild(child) 
                                        )}
                                    >
                                        <button
                                            onClick={(e) => { e.stopPropagation(); setEditingChildId(child.id); }}
                                            className="absolute top-2 right-2 p-2 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-colors opacity-0 group-hover:opacity-100 z-10"
                                            title="注专转 注爪"
                                        >
                                            <Settings className="w-4 h-4" />
                                        </button>

                                        <div className="flex flex-col items-center justify-center w-full h-full cursor-pointer">
                                            <div className={`w-24 h-24 rounded-full ${theme.iconBg} flex items-center justify-center shadow-inner group-hover:scale-110 transition-transform overflow-hidden relative`}>
                                                {useImage && image ? (
                                                    <img src={image} alt={name} className="w-full h-full object-cover" />
                                                ) : useEmoji ? (
                                                    <span className="text-5xl leading-none select-none">{emoji}</span>
                                                ) : (
                                                    <IconComponent className={`w-10 h-10 ${theme.iconText}`} />
                                                )}
                                            </div>
                                            
                                            <h2 className="text-2xl font-bold text-center mt-4" title="爪 专 注专转 砖">
                                                {name}
                                            </h2>
                                            
                                            <div className="flex gap-1 mt-2">
                                                {currentTasks.map((task, idx) => {
                                                    const isDone = completedTasks[`${getTodayKey()}_${child.id}_${task.id}`];
                                                    return (
                                                        <div key={task.id} className={`w-3 h-3 rounded-full ${isDone ? 'bg-green-500' : 'bg-slate-200'}`} />
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        <div className="absolute top-4 left-4 bg-slate-100 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                            <Plus className="w-5 h-5 text-slate-400" />
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </main>

                    {selectedChild && (
                        <TaskModal 
                            child={selectedChild}
                            tasks={getChildTasks(selectedChild.id)}
                            completedTasks={completedTasks}
                            visuals={getChildVisuals(selectedChild.id)}
                            onToggleTask={handleTaskToggle}
                            onClose={() => setSelectedChild(null)}
                            onAddTask={handleAddTask}
                            onDeleteTask={handleDeleteTask}
                            getTodayKey={getTodayKey}
                        />
                    )}

                    {editingChildId && (
                        <EditChildModal 
                            childId={editingChildId}
                            initialSettings={getChildVisuals(editingChildId)}
                            currentSettings={childSettings[editingChildId] || {}}
                            onClose={() => setEditingChildId(null)}
                            onSave={handleSaveSettings}
                            childName={CHILDREN_DEFAULTS.find(c => c.id === editingChildId)?.name}
                        />
                    )}

                    {showFamilyEditModal && (
                        <EditFamilyModal
                            initialSettings={getFamilyVisuals()}
                            currentSettings={familySettings}
                            onClose={() => setShowFamilyEditModal(false)}
                            onSave={handleSaveFamilySettings}
                        />
                    )}

                    {showBonusModal && (
                        <BonusModal 
                            onClose={() => setShowBonusModal(false)}
                            onConfirm={handleBonusPoint}
                        />
                    )}

                    {showWinModal && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md animate-fade-in">
                            <div className="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl p-8 text-center animate-scale-up border-8 border-yellow-300 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-32 bg-yellow-100 rounded-b-[50%] -translate-y-16"></div>
                                <div className="relative z-10">
                                    <div className="mx-auto w-32 h-32 bg-gradient-to-b from-yellow-300 to-yellow-500 rounded-full flex items-center justify-center mb-6 shadow-xl border-4 border-white animate-bounce">
                                        <Trophy className="w-16 h-16 text-white drop-shadow-md" />
                                    </div>
                                    <h2 className="text-5xl font-black text-slate-800 mb-2 tracking-tight"> !</h2>
                                    <h3 className="text-2xl font-bold text-slate-600 mb-6">注转 注 砖 {targetPoints} 拽转!</h3>
                                    <div className="p-4 bg-yellow-50 rounded-2xl mb-8 border-2 border-yellow-200">
                                        <p className="text-yellow-800 text-lg">"注转 爪转 转!"</p>
                                        <p className="text-yellow-700 font-bold mt-1">砖 !</p>
                                    </div>
                                    <button 
                                        onClick={handleResetPoints}
                                        className="w-full py-4 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold text-xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all flex items-center justify-center gap-2 group"
                                    >
                                        <RotateCcw className="w-6 h-6 group-hover:rotate-180 transition-transform duration-500" />
                                        驻住 拽转 转 砖
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <style>{`
                        @keyframes shimmer { 0% { transform: translateX(-150%); } 50% { transform: translateX(150%); } 100% { transform: translateX(150%); } }
                        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
                        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
                        @keyframes scale-up { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
                        .animate-fade-in { animation: fade-in 0.2s ease-out; }
                        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
                        .animate-scale-up { animation: scale-up 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
                    `}</style>
                </div>
            );
        }

        function BonusModal({ onClose, onConfirm }) {
            const [amount, setAmount] = useState(1);
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 text-center animate-scale-up">
                        <div className="mx-auto w-16 h-16 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center mb-4 shadow-lg">
                            <Sparkles className="w-8 h-8 text-white" />
                        </div>
                        <h3 className="text-2xl font-bold text-slate-800 mb-2">住驻转 住</h3>
                        <p className="text-slate-600 mb-6"> 拽转 住祝 抓 砖驻转?</p>
                        <div className="flex items-center justify-center gap-4 mb-8">
                            <button onClick={() => setAmount(Math.max(1, amount - 1))} className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold hover:bg-slate-200 transition-colors shadow-sm"><Minus className="w-6 h-6" /></button>
                            <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 w-24 tabular-nums">{amount}</div>
                            <button onClick={() => setAmount(Math.min(10, amount + 1))} className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold hover:bg-slate-200 transition-colors shadow-sm"><Plus className="w-6 h-6" /></button>
                        </div>
                        <input type="range" min="1" max="10" value={amount} onChange={(e) => setAmount(parseInt(e.target.value))} className="w-full mb-8 accent-orange-500 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                        <div className="flex gap-4 justify-center">
                            <button onClick={onClose} className="px-6 py-3 rounded-xl border-2 border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors"></button>
                            <button onClick={() => onConfirm(amount)} className="px-8 py-3 rounded-xl bg-gradient-to-r from-orange-400 to-red-500 text-white font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all">住祝 {amount} 拽转!</button>
                        </div>
                    </div>
                </div>
            );
        }

        function TaskModal({ child, tasks, completedTasks, visuals, onToggleTask, onClose, onAddTask, onDeleteTask, getTodayKey }) {
            const { theme, IconComponent, useEmoji, emoji, useImage, image, name } = visuals;
            const [isAdding, setIsAdding] = useState(false);
            const [newTaskText, setNewTaskText] = useState("");
            const [newTaskType, setNewTaskType] = useState("daily");
            const handleAddSubmit = () => {
                if (!newTaskText.trim()) return;
                onAddTask(child.id, newTaskText, newTaskType);
                setNewTaskText("");
                setIsAdding(false);
            }
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[90vh]" onClick={(e) => e.stopPropagation()}>
                        <div className={`${theme.iconBg} p-6 flex items-center justify-between flex-shrink-0`}>
                            <div className="flex items-center gap-4">
                                <div className="bg-white/50 p-1 rounded-full flex items-center justify-center w-16 h-16 overflow-hidden border-2 border-white/50">
                                    {useImage && image ? (
                                        <img src={image} alt={name} className="w-full h-full object-cover rounded-full" />
                                    ) : useEmoji ? (
                                        <span className="text-3xl">{emoji}</span>
                                    ) : (
                                        <IconComponent className={`w-8 h-8 ${theme.iconText}`} />
                                    )}
                                </div>
                                <div>
                                    <h2 className="text-3xl font-bold text-slate-800">{name}</h2>
                                    <p className="text-slate-600 text-lg">砖转 </p>
                                </div>
                            </div>
                            <button onClick={onClose} className="bg-white/50 p-2 rounded-full hover:bg-white/80 transition-colors"><X className="w-6 h-6 text-slate-700" /></button>
                        </div>
                        <div className="p-8 space-y-4 overflow-y-auto flex-1">
                            {tasks.map((task) => {
                                const taskKey = `${getTodayKey()}_${child.id}_${task.id}`;
                                const isDone = completedTasks[taskKey];
                                return (
                                    <div key={task.id} className="relative group">
                                        <button
                                            onClick={() => onToggleTask(child.id, task.id)}
                                            className={`w-full flex items-center justify-between p-5 rounded-2xl border-2 transition-all duration-200 ${isDone ? 'bg-green-50 border-green-200 shadow-none' : 'bg-white border-slate-100 shadow-md hover:border-blue-200'}`}
                                        >
                                            <div className="flex items-center gap-3">
                                                {task.type === 'one-time' && <Calendar className="w-4 h-4 text-blue-400" />}
                                                {task.type === 'daily' && <Repeat className="w-4 h-4 text-purple-400" />}
                                                {task.type === 'friday' && <CalendarDays className="w-4 h-4 text-pink-400" />}
                                                <span className={`text-xl font-medium ${isDone ? 'text-green-800 line-through opacity-70' : 'text-slate-700'}`}>{task.text}</span>
                                            </div>
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all ${isDone ? 'bg-green-500 border-green-500 scale-110' : 'bg-white border-slate-300 group-hover:border-blue-400'}`}>
                                                {isDone && <Check className="w-6 h-6 text-white" />}
                                            </div>
                                        </button>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onDeleteTask(child.id, task.id); }}
                                            className="absolute -left-2 top-1/2 -translate-y-1/2 -translate-x-full p-2 bg-red-100 text-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-200"
                                            title="拽 砖"
                                        >
                                            <Trash2 className="w-5 h-5" />
                                        </button>
                                    </div>
                                );
                            })}
                            {tasks.length > 0 && tasks.every((t) => completedTasks[`${getTodayKey()}_${child.id}_${t.id}`]) && (
                                <div className="mt-6 text-center bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-yellow-800 animate-pulse">
                                    <Star className="w-8 h-8 mx-auto mb-2 text-yellow-500 fill-yellow-500" />
                                    <p className="font-bold text-lg"> ! 住转 转  砖转 !</p>
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50">
                            {!isAdding ? (
                                <button onClick={() => setIsAdding(true)} className="w-full py-3 rounded-xl border-2 border-dashed border-slate-300 text-slate-500 font-bold hover:bg-white hover:border-blue-400 hover:text-blue-500 transition-all flex items-center justify-center gap-2">
                                    <Plus className="w-5 h-5" />
                                    住祝 砖 砖
                                </button>
                            ) : (
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm animate-fade-in">
                                    <input type="text" placeholder="砖 砖..." value={newTaskText} onChange={(e) => setNewTaskText(e.target.value)} className="w-full p-3 rounded-lg border border-slate-300 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-200" autoFocus />
                                    <div className="flex gap-2 mb-3">
                                        <button onClick={() => setNewTaskType('daily')} className={`flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border ${newTaskType === 'daily' ? 'bg-purple-100 text-purple-700 border-purple-300' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><Repeat className="w-4 h-4" /> </button>
                                        <button onClick={() => setNewTaskType('friday')} className={`flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border ${newTaskType === 'friday' ? 'bg-pink-100 text-pink-700 border-pink-300' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><CalendarDays className="w-4 h-4" />  砖砖</button>
                                        <button onClick={() => setNewTaskType('one-time')} className={`flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border ${newTaskType === 'one-time' ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><Calendar className="w-4 h-4" />专拽 </button>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setIsAdding(false)} className="flex-1 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg"></button>
                                        <button onClick={handleAddSubmit} className="flex-1 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md">砖专</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function EditChildModal({ childId, initialSettings, currentSettings, childName, onClose, onSave }) {
            const getInitialTab = () => {
                if (currentSettings.useImage) return 'image';
                if (currentSettings.useEmoji) return 'emoji';
                return 'icon';
            };
            const [activeTab, setActiveTab] = useState(getInitialTab());
            const [selectedThemeId, setSelectedThemeId] = useState(currentSettings.themeId || initialSettings.theme.id);
            const [selectedIconKey, setSelectedIconKey] = useState(currentSettings.iconKey || Object.keys(ICON_MAP).find(key => ICON_MAP[key] === initialSettings.IconComponent) || 'smile');
            const [customEmoji, setCustomEmoji] = useState(currentSettings.emoji || initialSettings.emoji);
            const [customImage, setCustomImage] = useState(currentSettings.image || initialSettings.image);
            const [customName, setCustomName] = useState(currentSettings.name || initialSettings.name);
            const [isProcessingImage, setIsProcessingImage] = useState(false);

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    setIsProcessingImage(true);
                    try {
                        const resizedBase64 = await resizeImage(file);
                        setCustomImage(resizedBase64);
                    } catch (err) {
                        console.error("Image processing error", err);
                    } finally {
                        setIsProcessingImage(false);
                    }
                }
            };
            const handleSave = () => {
                onSave(childId, {
                    themeId: selectedThemeId,
                    useEmoji: activeTab === 'emoji',
                    useImage: activeTab === 'image',
                    iconKey: selectedIconKey,
                    emoji: customEmoji || '',
                    image: customImage || null,
                    name: customName 
                });
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="text-xl font-bold text-slate-800">注专转 驻专 </h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><X className="w-5 h-5" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="mb-6">
                                <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Type className="w-5 h-5 text-slate-500" />砖 </h4>
                                <input type="text" value={customName} onChange={(e) => setCustomName(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none text-lg" placeholder="住 砖..." />
                            </div>
                            <div className="mb-8">
                                <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Palette className="w-5 h-5 text-purple-500" />专 爪注</h4>
                                <div className="flex flex-wrap gap-3">
                                    {THEMES.map(theme => (
                                        <button key={theme.id} onClick={() => setSelectedThemeId(theme.id)} className={`w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all ${theme.classes.split(' ')[0]} ${selectedThemeId === theme.id ? 'border-slate-800 scale-110 shadow-md ring-2 ring-slate-200' : 'border-transparent'}`}>
                                            {selectedThemeId === theme.id && <Check className={`w-5 h-5 ${theme.classes.split(' ')[1]}`} />}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Smile className="w-5 h-5 text-orange-500" />专 住, '  转</h4>
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-4">
                                    <button onClick={() => setActiveTab('icon')} className={`flex-1 py-2 rounded-lg font-medium transition-all ${activeTab === 'icon' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>住</button>
                                    <button onClick={() => setActiveTab('emoji')} className={`flex-1 py-2 rounded-lg font-medium transition-all ${activeTab === 'emoji' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>'</button>
                                    <button onClick={() => setActiveTab('image')} className={`flex-1 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${activeTab === 'image' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}><Camera className="w-4 h-4" />转</button>
                                </div>
                                {activeTab === 'icon' && (
                                    <div className="grid grid-cols-5 gap-3">
                                        {Object.entries(ICON_MAP).map(([key, IconCmp]) => (
                                            <button key={key} onClick={() => setSelectedIconKey(key)} className={`aspect-square rounded-xl flex items-center justify-center border-2 transition-all ${selectedIconKey === key ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-slate-200 text-slate-400 hover:border-blue-200'}`}>
                                                <IconCmp className="w-6 h-6" />
                                            </button>
                                        ))}
                                    </div>
                                )}
                                {activeTab === 'emoji' && (
                                    <div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <label className="text-sm text-slate-500 mb-2">拽  拽 ' :</label>
                                        <input type="text" value={customEmoji} onChange={(e) => setCustomEmoji(e.target.value)} className="w-24 h-24 text-center text-6xl rounded-2xl border-2 border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none bg-white" maxLength={2} />
                                    </div>
                                )}
                                {activeTab === 'image' && (
                                    <div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <div className="relative w-32 h-32 mb-4 group cursor-pointer">
                                            {customImage ? <img src={customImage} alt="Preview" className="w-full h-full object-cover rounded-full border-4 border-white shadow-md" /> : <div className="w-full h-full rounded-full bg-slate-200 flex items-center justify-center border-4 border-white shadow-md"><ImageIcon className="w-10 h-10 text-slate-400" /></div>}
                                            <label htmlFor="file-upload" className="absolute inset-0 flex items-center justify-center bg-black/30 text-white opacity-0 group-hover:opacity-100 rounded-full transition-opacity cursor-pointer"><Upload className="w-8 h-8" /></label>
                                            <input id="file-upload" type="file" accept="image/*" onChange={handleImageUpload} className="hidden" />
                                        </div>
                                        {isProcessingImage ? <p className="text-sm text-blue-500 animate-pulse">注 转...</p> : <label htmlFor="file-upload" className="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 cursor-pointer">专 转</label>}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} className="px-5 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-colors"></button>
                            <button onClick={handleSave} className="px-8 py-2.5 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">砖专 砖</button>
                        </div>
                    </div>
                </div>
            );
        }

        function EditFamilyModal({ initialSettings, currentSettings, onClose, onSave }) {
            const getInitialTab = () => {
                if (currentSettings.useImage) return 'image';
                if (currentSettings.useEmoji) return 'emoji';
                return 'icon';
            };
            const [activeTab, setActiveTab] = useState(getInitialTab());
            const [selectedThemeId, setSelectedThemeId] = useState(currentSettings.themeId || initialSettings.theme.id);
            const [selectedIconKey, setSelectedIconKey] = useState(currentSettings.iconKey || 'trophy');
            const [customEmoji, setCustomEmoji] = useState(currentSettings.emoji || '');
            const [customImage, setCustomImage] = useState(currentSettings.image || null);
            const [customTitle, setCustomTitle] = useState(currentSettings.title || initialSettings.title);
            const [customTarget, setCustomTarget] = useState(currentSettings.targetPoints || FAMILY_DEFAULT.defaultTarget);
            const [isProcessingImage, setIsProcessingImage] = useState(false);

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    setIsProcessingImage(true);
                    try {
                        const resizedBase64 = await resizeImage(file);
                        setCustomImage(resizedBase64);
                    } catch (err) {
                        console.error("Image processing error", err);
                    } finally {
                        setIsProcessingImage(false);
                    }
                }
            };
            const handleSave = () => {
                onSave({
                    themeId: selectedThemeId,
                    useEmoji: activeTab === 'emoji',
                    useImage: activeTab === 'image',
                    iconKey: selectedIconKey,
                    emoji: customEmoji || '',
                    image: customImage || null,
                    title: customTitle,
                    targetPoints: Number(customTarget)
                });
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="text-xl font-bold text-slate-800">注专转 转专转 住</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><X className="w-5 h-5" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="mb-6">
                                <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Type className="w-5 h-5 text-slate-500" />转专转 驻拽爪</h4>
                                <input type="text" value={customTitle} onChange={(e) => setCustomTitle(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none text-lg" placeholder="住 转专转..." />
                            </div>
                            <div className="mb-6">
                                <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Target className="w-5 h-5 text-slate-500" />注 拽转</h4>
                                <input type="number" value={customTarget} onChange={(e) => setCustomTarget(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none text-lg" placeholder="100" min="1" />
                            </div>
                            <div className="mb-8">
                                <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Palette className="w-5 h-5 text-purple-500" />专 爪注</h4>
                                <div className="flex flex-wrap gap-3">
                                    {THEMES.map(theme => (
                                        <button key={theme.id} onClick={() => setSelectedThemeId(theme.id)} className={`w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all ${theme.classes.split(' ')[0]} ${selectedThemeId === theme.id ? 'border-slate-800 scale-110 shadow-md ring-2 ring-slate-200' : 'border-transparent'}`}>
                                            {selectedThemeId === theme.id && <Check className={`w-5 h-5 ${theme.classes.split(' ')[1]}`} />}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Smile className="w-5 h-5 text-orange-500" />专 住, '  转</h4>
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-4">
                                    <button onClick={() => setActiveTab('icon')} className={`flex-1 py-2 rounded-lg font-medium transition-all ${activeTab === 'icon' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>住</button>
                                    <button onClick={() => setActiveTab('emoji')} className={`flex-1 py-2 rounded-lg font-medium transition-all ${activeTab === 'emoji' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>'</button>
                                    <button onClick={() => setActiveTab('image')} className={`flex-1 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${activeTab === 'image' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}><Camera className="w-4 h-4" />转</button>
                                </div>
                                {activeTab === 'icon' && (
                                    <div className="grid grid-cols-5 gap-3">
                                        {Object.entries(ICON_MAP).map(([key, IconCmp]) => (
                                            <button key={key} onClick={() => setSelectedIconKey(key)} className={`aspect-square rounded-xl flex items-center justify-center border-2 transition-all ${selectedIconKey === key ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-slate-200 text-slate-400 hover:border-blue-200'}`}>
                                                <IconCmp className="w-6 h-6" />
                                            </button>
                                        ))}
                                    </div>
                                )}
                                {activeTab === 'emoji' && (
                                    <div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <label className="text-sm text-slate-500 mb-2">拽  拽 ' :</label>
                                        <input type="text" value={customEmoji} onChange={(e) => setCustomEmoji(e.target.value)} className="w-24 h-24 text-center text-6xl rounded-2xl border-2 border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none bg-white" maxLength={2} />
                                    </div>
                                )}
                                {activeTab === 'image' && (
                                    <div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <div className="relative w-32 h-32 mb-4 group cursor-pointer">
                                            {customImage ? <img src={customImage} alt="Preview" className="w-full h-full object-cover rounded-full border-4 border-white shadow-md" /> : <div className="w-full h-full rounded-full bg-slate-200 flex items-center justify-center border-4 border-white shadow-md"><ImageIcon className="w-10 h-10 text-slate-400" /></div>}
                                            <label htmlFor="file-upload-family" className="absolute inset-0 flex items-center justify-center bg-black/30 text-white opacity-0 group-hover:opacity-100 rounded-full transition-opacity cursor-pointer"><Upload className="w-8 h-8" /></label>
                                            <input id="file-upload-family" type="file" accept="image/*" onChange={handleImageUpload} className="hidden" />
                                        </div>
                                        {isProcessingImage ? <p className="text-sm text-blue-500 animate-pulse">注 转...</p> : <label htmlFor="file-upload-family" className="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 cursor-pointer">专 转</label>}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} className="px-5 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-colors"></button>
                            <button onClick={handleSave} className="px-8 py-2.5 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">砖专 砖</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

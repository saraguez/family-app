<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×”××‘×¦×¢ ×”××©×¤×—×ª×™</title>
    
    <!-- ERROR HANDLER -->
    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const container = document.getElementById('root') || document.body;
            container.innerHTML = `
                <div style="background:#fee2e2; color:#991b1b; padding:20px; margin:20px; border-radius:10px; border: 2px solid #ef4444; direction:ltr; text-align:left;">
                    <h2 style="font-size:24px; font-weight:bold; margin-bottom:10px;">âš ï¸ App Crashed</h2>
                    <p style="font-weight:bold;">Error: ${msg}</p>
                    <p>Line: ${lineNo}</p>
                </div>
            `;
            return false;
        };
    </script>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ†</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @keyframes shimmer { 0% { transform: translateX(-150%); } 50% { transform: translateX(150%); } 100% { transform: translateX(150%); } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scale-up { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-scale-up { animation: scale-up 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans select-none overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCET42vMcj1uC0nMsqsWy2xd-yv1WC7e68",
            authDomain: "family-tasks-ee68f.firebaseapp.com",
            projectId: "family-tasks-ee68f",
            storageBucket: "family-tasks-ee68f.firebasestorage.app",
            messagingSenderId: "579816138584",
            appId: "1:579816138584:web:1b2a3cbf4c5fd00a45e72d"
        };

        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfigRaw);
            } catch(e) {
                console.error("Firebase Init Error:", e);
                throw e;
            }
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'family-tasks-default';

        // --- ICONS & HELPERS ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Icons = {
            Trophy: (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5 2.5 2.5 0 0 0 0 5z"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2z"/></IconBase>,
            Star: (p) => <IconBase {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>,
            Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
            Plus: (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>,
            Minus: (p) => <IconBase {...p}><line x1="5" y1="12" x2="19" y2="12"/></IconBase>,
            X: (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>,
            Sparkles: (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 21v-4"/><path d="M15 19h4"/></IconBase>,
            Utensils: (p) => <IconBase {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>,
            Shirt: (p) => <IconBase {...p}><path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/></IconBase>,
            Gamepad2: (p) => <IconBase {...p}><line x1="6" y1="12" x2="10" y2="12"/><line x1="8" y1="10" x2="8" y2="14"/><line x1="15" y1="13" x2="15.01" y2="13"/><line x1="18" y1="11" x2="18.01" y2="11"/><rect x="2" y="6" width="20" height="12" rx="2"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>,
            Home: (p) => <IconBase {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>,
            Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Smile: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></IconBase>,
            Heart: (p) => <IconBase {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>,
            Sun: (p) => <IconBase {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>,
            Moon: (p) => <IconBase {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>,
            Music: (p) => <IconBase {...p}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></IconBase>,
            Book: (p) => <IconBase {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconBase>,
            Bike: (p) => <IconBase {...p}><circle cx="5.5" cy="17.5" r="3.5"/><circle cx="18.5" cy="17.5" r="3.5"/><path d="M15 6h-5a1 1 0 0 0-1 1v4"/><path d="M12 17.5V14l-3-3 4-3 2 3h2"/></IconBase>,
            Car: (p) => <IconBase {...p}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></IconBase>,
            Cat: (p) => <IconBase {...p}><path d="M12 5c.67 0 1.35.09 2 .26 1.78-2 5.03-2.84 6.42-2.26 1.4.58-.42 7-.42 7 .57 1.07 1 2.24 1 3.44C21 17.9 16.97 21 12 21s-9-3.1-9-7.56c0-1.25.5-2.4 1-3.44 0 0-1.89-6.42-.5-7 1.39-.58 4.72.23 6.5 2.23A9.04 9.04 0 0 1 12 5Z"/><path d="M8 14v.5"/><path d="M16 14v.5"/><path d="M11.25 16.25h1.5"/></IconBase>,
            Dog: (p) => <IconBase {...p}><path d="M10 5.172C10 3.782 8.423 2.679 6.5 3c-2.823.47-4.113 6.006-4 7 .08.703 1.725 1.722 3.656 1 1.261-.472 1.96-1.45 2.344-2.5"/><path d="M14.267 5.172c0-1.39 1.577-2.493 3.5-2.172 2.823.47 4.113 6.006 4 7-.08.703-1.725 1.722-3.656 1-1.261-.472-1.96-1.45-2.344-2.5"/><path d="M8 14v.5"/><path d="M16 14v.5"/><path d="M11.25 16.25h1.5"/><path d="M12 21c5.523 0 10-4.477 10-10S17.523 1 12 1 2 5.477 2 11s4.477 10 10 10Z"/></IconBase>,
            Flower: (p) => <IconBase {...p}><path d="M12 7.5a4.5 4.5 0 1 1 4.5 4.5M12 7.5A4.5 4.5 0 1 0 7.5 12M12 7.5V9m-4.5 3a4.5 4.5 0 1 1 4.5 4.5M7.5 12H9m3 4.5a4.5 4.5 0 1 1 4.5-4.5M12 16.5V15m4.5-3h-1.5"/><path d="m8 22 4-6 4 6"/><path d="M16 8a2 2 0 1 0 4 0 2 2 0 1 0-4 0"/><path d="M4 8a2 2 0 1 0 4 0 2 2 0 1 0-4 0"/><path d="M8 16a2 2 0 1 0 4 0 2 2 0 1 0-4 0"/><path d="M16 16a2 2 0 1 0 4 0 2 2 0 1 0-4 0"/><path d="M12 12a2 2 0 1 0 4 0 2 2 0 1 0-4 0"/></IconBase>,
            Palette: (p) => <IconBase {...p}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></IconBase>,
            Camera: (p) => <IconBase {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>,
            Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>,
            ImageIcon: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>,
            Type: (p) => <IconBase {...p}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></IconBase>,
            Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>,
            Repeat: (p) => <IconBase {...p}><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></IconBase>,
            MoreVertical: (p) => <IconBase {...p}><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></IconBase>,
            RotateCcw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>,
            Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
            CalendarDays: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></IconBase>,
            Sunrise: (p) => <IconBase {...p}><path d="M12 2v8"/><path d="m4.93 10.93 1.41 1.41"/><path d="M2 18h2"/><path d="M20 18h2"/><path d="m19.07 10.93-1.41 1.41"/><path d="M22 22H2"/><path d="m8 6 4-4 4 4"/><path d="M16 18a4 4 0 0 0-8 0"/></IconBase>,
            Sunset: (p) => <IconBase {...p}><path d="M12 10V2"/><path d="m4.93 10.93 1.41 1.41"/><path d="M2 18h2"/><path d="M20 18h2"/><path d="m19.07 10.93-1.41 1.41"/><path d="M22 22H2"/><path d="m16 6-4 4-4-4"/><path d="M16 18a4 4 0 0 0-8 0"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            Unlock: (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>,
            History: (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>,
            Pencil: (p) => <IconBase {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></IconBase>,
            CheckSquare: (p) => <IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>,
            ArrowUp: (p) => <IconBase {...p}><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></IconBase>,
            ArrowDown: (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            Coins: (p) => <IconBase {...p}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m7.1 13.8 3-3.8"/></IconBase>,
            UserPlus: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></IconBase>,
            BarChart: (p) => <IconBase {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconBase>
        };

        const ICON_MAP = {
            'trophy': Icons.Trophy, 'utensils': Icons.Utensils, 'shirt': Icons.Shirt, 'gamepad': Icons.Gamepad2, 'home': Icons.Home, 'star': Icons.Star, 'heart': Icons.Heart, 'smile': Icons.Smile, 'sun': Icons.Sun, 'moon': Icons.Moon, 'music': Icons.Music, 'book': Icons.Book, 'bike': Icons.Bike, 'car': Icons.Car, 'cat': Icons.Cat, 'dog': Icons.Dog, 'flower': Icons.Flower, 'camera': Icons.Camera, 'sparkles': Icons.Sparkles
        };

        const THEMES = [
            { id: 'pink', name: '×•×¨×•×“', classes: 'bg-pink-100 text-pink-700 border-pink-300', iconBg: 'bg-pink-200', iconText: 'text-pink-600' },
            { id: 'blue', name: '×›×—×•×œ', classes: 'bg-blue-100 text-blue-700 border-blue-300', iconBg: 'bg-blue-200', iconText: 'text-blue-600' },
            { id: 'green', name: '×™×¨×•×§', classes: 'bg-green-100 text-green-700 border-green-300', iconBg: 'bg-green-200', iconText: 'text-green-600' },
            { id: 'purple', name: '×¡×’×•×œ', classes: 'bg-purple-100 text-purple-700 border-purple-300', iconBg: 'bg-purple-200', iconText: 'text-purple-600' },
            { id: 'yellow', name: '×¦×”×•×‘', classes: 'bg-yellow-100 text-yellow-700 border-yellow-300', iconBg: 'bg-yellow-200', iconText: 'text-yellow-600' },
            { id: 'orange', name: '×›×ª×•×', classes: 'bg-orange-100 text-orange-700 border-orange-300', iconBg: 'bg-orange-200', iconText: 'text-orange-600' },
            { id: 'teal', name: '×˜×•×¨×§×™×–', classes: 'bg-teal-100 text-teal-700 border-teal-300', iconBg: 'bg-teal-200', iconText: 'text-teal-600' },
            { id: 'red', name: '××“×•×', classes: 'bg-red-100 text-red-700 border-red-300', iconBg: 'bg-red-200', iconText: 'text-red-600' },
        ];

        // --- HELPER FOR DEFAULT TASKS ---
        const getStandardTasks = (prefix) => [
            { id: `${prefix}_m1`, text: '×××¨×ª×™ ××•×“×” ×× ×™ â˜€ï¸', type: 'morning' },
            { id: `${prefix}_m2`, text: '× ×˜×œ×ª×™ ×™×“×™×™× ğŸ’§', type: 'morning' },
            { id: `${prefix}_m3`, text: '×¦×—×¦×—×ª×™ ×©×™× ×™×™× ğŸ¦·ğŸª¥', type: 'morning' },
            { id: `${prefix}_m4`, text: '×”×ª×œ×‘×©×ª×™ ×‘×–×¨×™×–×•×ª ğŸ‘•', type: 'morning' },
            { id: `${prefix}_m5`, text: '×¡×™×“×¨×ª×™ ××ª ×”××™×˜×” ×©×œ×™ ğŸ›ï¸', type: 'morning' },
            { id: `${prefix}_m6`, text: '×™×¦××ª×™ ×‘×–××Ÿ ğŸšª', type: 'morning' },
            
            { id: `${prefix}_e1`, text: '×”×›× ×ª×™ ××•×›×œ ×œ××—×¨ ğŸ¥ª', type: 'evening' },
            { id: `${prefix}_e2`, text: '×”×›× ×ª×™ ×‘×’×“×™× ×œ××—×¨ ğŸ‘”', type: 'evening' },
            { id: `${prefix}_e3`, text: '×”×ª×§×œ×—×ª×™ ğŸš¿', type: 'evening' },
            { id: `${prefix}_e4`, text: '×¦×—×¦×—×ª×™ ×©×™× ×™×™× ğŸ¦·ğŸª¥', type: 'evening' },
            { id: `${prefix}_e5`, text: '×”×›× ×ª×™ × ×˜×œ×” ×œ×™×“ ×”××™×˜×” ğŸ›ï¸', type: 'evening' },
            { id: `${prefix}_e6`, text: '×”×§×©×‘×ª×™ ×™×¤×” ×œ×¡×™×¤×•×¨ ğŸ“–', type: 'evening' },
            { id: `${prefix}_e7`, text: '×××¨×ª×™ ×§×¨×™××ª ×©××¢ ğŸ˜´', type: 'evening' }
        ];

        const CHILDREN_DEFAULTS = [
            { 
                id: 'daughter', 
                name: '×™×œ×“×”', 
                defaultThemeId: 'pink', 
                defaultIconKey: 'smile', 
                initialTasks: getStandardTasks('daughter')
            },
            { 
                id: 'son', 
                name: '×™×œ×“', 
                defaultThemeId: 'blue', 
                defaultIconKey: 'smile', 
                initialTasks: getStandardTasks('son')
            }
        ];

        const FAMILY_DEFAULT = { defaultThemeId: 'yellow', defaultIconKey: 'trophy', defaultTitle: '×”××‘×¦×¢ ×”××©×¤×—×ª×™', defaultTarget: 100, defaultPointsPerShekel: 5 };

        const toHebrewNumeral = (n) => {
            if (!n || n < 1 || n > 31) return n;
            const letters = ['', '××³', '×‘×³', '×’×³', '×“×³', '×”×³', '×•×³', '×–×³', '×—×³', '×˜×³', '×™×³', '×™×´×', '×™×´×‘', '×™×´×’', '×™×´×“', '×˜×´×•', '×˜×´×–', '×™×´×–', '×™×´×—', '×™×´×˜', '×›×³', '×›×´×', '×›×´×‘', '×›×´×’', '×›×´×“', '×›×´×”', '×›×´×•', '×›×´×–', '×›×´×—', '×›×´×˜', '×œ×³', '×œ×´×'];
            return letters[n] || n;
        };

        const resizeImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 300;
                        const MAX_HEIGHT = 300;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } 
                        else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        const playSuccessSound = () => {
            try {
                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3');
                audio.volume = 0.5;
                audio.play().catch(e => console.log("Audio play failed", e));
            } catch (e) { console.error("Audio error", e); }
        };

        // --- COMPONENTS ---

        function Confetti({ density = 150 }) {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const updateSize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
                updateSize();
                window.addEventListener('resize', updateSize);
                const colors = ['#FCD34D', '#F87171', '#60A5FA', '#34D399', '#A78BFA', '#F472B6'];
                const particles = Array.from({ length: density }).map(() => ({
                    x: Math.random() * canvas.width, y: -Math.random() * canvas.height, color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4, weight: Math.random() * 3 + 2, angle: Math.random() * 360, spin: Math.random() * 5 - 2.5, oscillationSpeed: Math.random() * 0.05 + 0.02
                }));
                let animationId;
                function animate() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles.forEach(p => {
                        p.y += p.weight; p.angle += p.spin; p.x += Math.sin(p.angle * p.oscillationSpeed) * 2;
                        if (p.y > canvas.height) { p.y = -10; p.x = Math.random() * canvas.width; }
                        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle * Math.PI / 180); ctx.fillStyle = p.color;
                        ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size); ctx.restore();
                    });
                    animationId = requestAnimationFrame(animate);
                }
                animate();
                return () => { cancelAnimationFrame(animationId); window.removeEventListener('resize', updateSize); };
            }, [density]);
            return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-[100]" />;
        }

        const LoginScreen = ({ onLogin }) => {
            return (
                <div className="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center">
                        <div className="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                            <Icons.Trophy className="w-10 h-10 text-yellow-600" />
                        </div>
                        <h1 className="text-3xl font-black text-slate-800 mb-2">×”××‘×¦×¢ ×”××©×¤×—×ª×™</h1>
                        <p className="text-slate-500 mb-8">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                        <div className="animate-spin rounded-full h-10 w-10 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
                    </div>
                </div>
            );
        };

        const BonusModal = ({ onClose, onConfirm, childrenData, childSettings }) => {
            const [amount, setAmount] = useState(1);
            const [selectedChildId, setSelectedChildId] = useState(null); // null = family

            const getChildAvatar = (child) => {
                const settings = childSettings[child.id] || {};
                const themeId = settings.themeId || child.defaultThemeId;
                const theme = THEMES.find(t => t.id === themeId) || THEMES[0];
                const useImage = settings.useImage; const image = settings.image; const useEmoji = settings.useEmoji; const emoji = settings.emoji || 'ğŸ˜Š'; const iconKey = settings.iconKey || child.defaultIconKey;
                const IconComponent = ICON_MAP[iconKey] || Icons.Smile;
                return { theme, useImage, image, useEmoji, emoji, IconComponent };
            };

            const handleConfirm = () => {
                onConfirm(amount, selectedChildId);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 text-center animate-scale-up max-h-[90vh] overflow-y-auto">
                        <div className="mx-auto w-16 h-16 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center mb-4 shadow-lg"><Icons.Sparkles className="w-8 h-8 text-white" /></div>
                        <h3 className="text-2xl font-bold text-slate-800 mb-2">×”×•×¡×¤×ª ×‘×•× ×•×¡</h3>
                        
                        {/* Child Selection Grid */}
                        <div className="mb-6">
                            <p className="text-slate-600 mb-3 font-bold text-sm">×œ××™ ×”×‘×•× ×•×¡?</p>
                            <div className="grid grid-cols-3 gap-3">
                                {/* Family Option */}
                                <button 
                                    onClick={() => setSelectedChildId(null)}
                                    className={`flex flex-col items-center gap-1 p-2 rounded-xl border-2 transition-all ${selectedChildId === null ? 'border-orange-500 bg-orange-50 ring-2 ring-orange-200' : 'border-transparent hover:bg-slate-50'}`}
                                >
                                    <div className="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600">
                                        <Icons.Trophy className="w-6 h-6" />
                                    </div>
                                    <span className="text-xs font-bold truncate w-full">×”××©×¤×—×”</span>
                                </button>

                                {/* Children Options */}
                                {childrenData.map(child => {
                                    const visuals = getChildAvatar(child);
                                    const { theme } = visuals;
                                    return (
                                        <button 
                                            key={child.id}
                                            onClick={() => setSelectedChildId(child.id)}
                                            className={`flex flex-col items-center gap-1 p-2 rounded-xl border-2 transition-all ${selectedChildId === child.id ? 'border-orange-500 bg-orange-50 ring-2 ring-orange-200' : 'border-transparent hover:bg-slate-50'}`}
                                        >
                                            <div className={`w-10 h-10 rounded-full ${theme.iconBg} flex items-center justify-center overflow-hidden`}>
                                                {visuals.useImage && visuals.image ? 
                                                    <img src={visuals.image} className="w-full h-full object-cover" /> : 
                                                    (visuals.useEmoji ? <span className="text-lg">{visuals.emoji}</span> : <visuals.IconComponent className={`w-5 h-5 ${theme.iconText}`} />)
                                                }
                                            </div>
                                            <span className="text-xs font-bold truncate w-full">{childSettings[child.id]?.name || child.name}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="flex items-center justify-center gap-4 mb-6">
                            <button onClick={() => setAmount(Math.max(1, amount - 1))} className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold hover:bg-slate-200 transition-colors shadow-sm"><Icons.Minus className="w-6 h-6" /></button>
                            <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 w-24 tabular-nums">{amount}</div>
                            <button onClick={() => setAmount(Math.min(10, amount + 1))} className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold hover:bg-slate-200 transition-colors shadow-sm"><Icons.Plus className="w-6 h-6" /></button>
                        </div>
                        <input type="range" min="1" max="10" value={amount} onChange={(e) => setAmount(parseInt(e.target.value))} className="w-full mb-6 accent-orange-500 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                        
                        <div className="flex gap-4 justify-center">
                            <button onClick={onClose} className="px-6 py-3 rounded-xl border-2 border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors">×‘×™×˜×•×œ</button>
                            <button onClick={handleConfirm} className="px-8 py-3 rounded-xl bg-gradient-to-r from-orange-400 to-red-500 text-white font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all">×”×•×¡×£ {amount} × ×§×•×“×•×ª!</button>
                        </div>
                    </div>
                </div>
            );
        };

        const CashOutModal = ({ onClose, onConfirm, currentBalance, childName }) => {
            const [amount, setAmount] = useState(0);
            
            const handleConfirm = () => {
                if (amount > 0 && amount <= currentBalance) {
                    onConfirm(amount);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 text-center animate-scale-up">
                        <div className="mx-auto w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full flex items-center justify-center mb-4 shadow-lg"><Icons.Coins className="w-8 h-8 text-white" /></div>
                        <h3 className="text-2xl font-bold text-slate-800 mb-1">×¤×“×™×•×Ÿ ×›×¡×£</h3>
                        <p className="text-slate-500 mb-6">×¢×‘×•×¨ {childName}</p>
                        
                        <div className="bg-slate-50 rounded-xl p-4 mb-6 border border-slate-100">
                            <p className="text-sm text-slate-500 mb-1">×™×ª×¨×” × ×•×›×—×™×ª</p>
                            <p className="text-3xl font-black text-green-600">â‚ª{currentBalance}</p>
                        </div>

                        <div className="mb-6">
                            <label className="block text-sm font-bold text-slate-700 mb-2">×›××” ×œ×¤×“×•×ª?</label>
                            <div className="flex items-center justify-center gap-4">
                                <button onClick={() => setAmount(Math.max(0, amount - 1))} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold hover:bg-slate-200"><Icons.Minus className="w-5 h-5" /></button>
                                <div className="text-4xl font-bold text-slate-800 w-20 tabular-nums">â‚ª{amount}</div>
                                <button onClick={() => setAmount(Math.min(currentBalance, amount + 1))} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold hover:bg-slate-200"><Icons.Plus className="w-5 h-5" /></button>
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 rounded-xl border-2 border-slate-200 text-slate-600 font-bold hover:bg-slate-50">×‘×™×˜×•×œ</button>
                            <button 
                                onClick={handleConfirm} 
                                disabled={amount === 0 || amount > currentBalance}
                                className={`flex-1 py-3 rounded-xl font-bold text-white shadow-lg transition-all ${amount > 0 && amount <= currentBalance ? 'bg-green-600 hover:bg-green-700 hover:scale-105' : 'bg-slate-300 cursor-not-allowed'}`}
                            >
                                ×¤×“×” ×›×¡×£
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const PinModal = ({ onClose, onSuccess, correctPin }) => {
            const [pin, setPin] = useState("");
            const [error, setError] = useState(false);
            const handleNumber = (num) => { if (pin.length < 4) { setPin(prev => prev + num); setError(false); } };
            const handleBackspace = () => setPin(prev => prev.slice(0, -1));
            const handleSubmit = () => { if (pin === correctPin) { onSuccess(); } else { setError(true); setPin(""); } };
            return (
                <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/50 backdrop-blur-md animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 text-center">
                        <div className="mb-6"><div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Lock className="w-8 h-8 text-slate-500" /></div><h3 className="text-xl font-bold text-slate-800">×§×•×“ ×”×•×¨×™×</h3><p className="text-slate-500 text-sm">×× × ×”×§×© ×§×•×“ ×’×™×©×” ×œ×‘×™×¦×•×¢ ×¤×¢×•×œ×” ×–×•</p></div>
                        <div className="flex justify-center gap-4 mb-8">{[0, 1, 2, 3].map(i => (<div key={i} className={`w-4 h-4 rounded-full transition-all ${i < pin.length ? 'bg-blue-500 scale-110' : 'bg-slate-200'}`} />))}</div>
                        {error && <p className="text-red-500 text-sm font-bold mb-4 animate-pulse">×§×•×“ ×©×’×•×™, × ×¡×” ×©× ×™×ª</p>}
                        <div className="grid grid-cols-3 gap-3 mb-6">{[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (<button key={n} onClick={() => handleNumber(n)} className="h-16 rounded-2xl bg-slate-50 hover:bg-slate-100 font-bold text-2xl text-slate-700 transition-colors shadow-sm">{n}</button>))}<div></div><button onClick={() => handleNumber(0)} className="h-16 rounded-2xl bg-slate-50 hover:bg-slate-100 font-bold text-2xl text-slate-700 transition-colors shadow-sm">0</button><button onClick={handleBackspace} className="h-16 rounded-2xl hover:bg-red-50 flex items-center justify-center text-slate-400 hover:text-red-500 transition-colors"><Icons.X className="w-6 h-6" /></button></div>
                        <div className="flex gap-2"><button onClick={onClose} className="flex-1 py-3 rounded-xl bg-slate-100 font-bold text-slate-600 hover:bg-slate-200">×‘×™×˜×•×œ</button><button onClick={handleSubmit} className="flex-1 py-3 rounded-xl bg-blue-600 font-bold text-white hover:bg-blue-700 shadow-md">××™×©×•×¨</button></div>
                    </div>
                </div>
            );
        };

        const TaskItem = ({ task, childId, isDone, onToggleTask, onDeleteTask, onEditTask, onMoveTask }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editText, setEditText] = useState(task.text);
            const [editType, setEditType] = useState(task.type);

            const handleSave = () => {
                onEditTask(childId, task.id, editText, editType);
                setIsEditing(false);
            };

            if (isEditing) {
                return (
                    <div className="bg-slate-50 p-4 rounded-2xl border-2 border-blue-200 mb-3 animate-fade-in">
                        <input type="text" value={editText} onChange={(e) => setEditText(e.target.value)} className="w-full p-2 mb-3 rounded-lg border border-slate-300" />
                        <div className="grid grid-cols-2 gap-2 mb-3">
                            <button onClick={() => setEditType('morning')} className={`py-1 text-xs rounded border ${editType === 'morning' ? 'bg-orange-100 border-orange-300' : 'bg-white'}`}>×‘×•×§×¨</button>
                            <button onClick={() => setEditType('evening')} className={`py-1 text-xs rounded border ${editType === 'evening' ? 'bg-indigo-100 border-indigo-300' : 'bg-white'}`}>×¢×¨×‘</button>
                            <button onClick={() => setEditType('friday')} className={`py-1 text-xs rounded border ${editType === 'friday' ? 'bg-pink-100 border-pink-300' : 'bg-white'}`}>×©×™×©×™</button>
                            <button onClick={() => setEditType('one-time')} className={`py-1 text-xs rounded border ${editType === 'one-time' ? 'bg-blue-100 border-blue-300' : 'bg-white'}`}>×”×™×•×</button>
                        </div>
                        <div className="flex justify-between items-center">
                            <div className="flex gap-2">
                                <button onClick={() => onMoveTask(childId, task.id, 'up')} className="p-2 bg-white rounded-lg border hover:bg-slate-100"><Icons.ArrowUp className="w-4 h-4" /></button>
                                <button onClick={() => onMoveTask(childId, task.id, 'down')} className="p-2 bg-white rounded-lg border hover:bg-slate-100"><Icons.ArrowDown className="w-4 h-4" /></button>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setIsEditing(false)} className="p-2 text-slate-500">×‘×™×˜×•×œ</button>
                                <button onClick={handleSave} className="p-2 bg-blue-500 text-white rounded-lg"><Icons.Save className="w-4 h-4" /></button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="relative group mb-3 flex items-center gap-2">
                    <button type="button" onClick={() => onToggleTask(childId, task.id, task.text)} className={`flex-1 flex items-center justify-between p-5 rounded-2xl border-2 transition-all duration-200 cursor-pointer select-none active:scale-[0.98] ${isDone ? 'bg-green-50 border-green-200 shadow-none' : 'bg-white border-slate-100 shadow-md hover:border-blue-200'}`} style={{ WebkitTapHighlightColor: 'transparent' }}>
                        <div className="flex items-center gap-3">
                            {task.type === 'one-time' && <Icons.Calendar className="w-4 h-4 text-blue-400" />}
                            {task.type === 'daily' && <Icons.Repeat className="w-4 h-4 text-purple-400" />}
                            {task.type === 'friday' && <Icons.CalendarDays className="w-4 h-4 text-pink-400" />}
                            {task.type === 'morning' && <Icons.Sunrise className="w-4 h-4 text-orange-400" />}
                            {(task.type === 'evening' || task.type === 'daily') && <Icons.Moon className="w-4 h-4 text-indigo-400" />}
                            <span className={`text-xl font-medium ${isDone ? 'text-green-800 line-through opacity-70' : 'text-slate-700'}`}>{task.text}</span>
                        </div>
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all ${isDone ? 'bg-green-500 border-green-500 scale-110' : 'bg-white border-slate-300 group-hover:border-blue-400'}`}>
                            {isDone && <Icons.Check className="w-6 h-6 text-white" />}
                        </div>
                    </button>
                    <button onClick={() => setIsEditing(true)} className="p-3 bg-slate-100 rounded-xl text-slate-400 hover:text-blue-500 hover:bg-blue-50 transition-colors"><Icons.Pencil className="w-5 h-5" /></button>
                    <button onClick={(e) => { e.stopPropagation(); onDeleteTask(childId, task.id); }} className="p-3 bg-red-50 rounded-xl text-red-300 hover:text-red-500 hover:bg-red-100 transition-colors" title="××—×§ ××©×™××”"><Icons.Trash2 className="w-5 h-5" /></button>
                </div>
            );
        };

        const TaskModal = ({ child, tasks, completedTasks, visuals, onToggleTask, onClose, onAddTask, onDeleteTask, onEditTask, onMoveTask, getTodayKey }) => {
            const { theme, IconComponent, useEmoji, emoji, useImage, image, name } = visuals;
            const [isAdding, setIsAdding] = useState(false);
            const [newTaskText, setNewTaskText] = useState("");
            const [newTaskType, setNewTaskType] = useState("evening");
            const [addToAll, setAddToAll] = useState(false);

            const handleAddSubmit = () => {
                if (!newTaskText.trim()) return;
                onAddTask(child.id, newTaskText, newTaskType, addToAll);
                setNewTaskText("");
                setAddToAll(false);
                setIsAdding(false);
            }

            // --- IMPROVED TASK GROUPING ---
            const morningTasks = tasks.filter(t => t.type === 'morning');
            const fridayTasks = tasks.filter(t => t.type === 'friday');
            const otherTasks = tasks.filter(t => t.type !== 'morning' && t.type !== 'friday');

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[90vh] z-[70] relative" onClick={(e) => e.stopPropagation()}>
                        <div className={`${theme.iconBg} p-6 flex items-center justify-between flex-shrink-0`}>
                            <div className="flex items-center gap-4">
                                <div className="bg-white/50 p-1 rounded-full flex items-center justify-center w-16 h-16 overflow-hidden border-2 border-white/50">
                                    {useImage && image ? <img src={image} alt={name} className="w-full h-full object-cover rounded-full" /> : useEmoji ? <span className="text-3xl">{emoji}</span> : <IconComponent className={`w-8 h-8 ${theme.iconText}`} />}
                                </div>
                                <div><h2 className="text-3xl font-bold text-slate-800">{name}</h2><p className="text-slate-600 text-lg">×”××©×™××•×ª ×œ×”×™×•×</p></div>
                            </div>
                            <button onClick={onClose} className="bg-white/50 p-2 rounded-full hover:bg-white/80 transition-colors"><Icons.X className="w-6 h-6 text-slate-700" /></button>
                        </div>
                        <div className="p-8 space-y-2 overflow-y-auto flex-1">
                            
                            {/* BOKER */}
                            {morningTasks.length > 0 && (
                                <div className="mb-6">
                                    <h4 className="text-lg font-bold text-orange-500 mb-3 flex items-center gap-2"><Icons.Sunrise className="w-5 h-5" />×‘×•×§×¨</h4>
                                    {morningTasks.map(task => <TaskItem key={task.id} task={task} childId={child.id} isDone={completedTasks[`${getTodayKey()}_${child.id}_${task.id}`]} onToggleTask={onToggleTask} onDeleteTask={onDeleteTask} onEditTask={onEditTask} onMoveTask={onMoveTask} />)}
                                </div>
                            )}

                            {/* FRIDAY */}
                            {fridayTasks.length > 0 && (
                                <div className="mb-6">
                                    <h4 className="text-lg font-bold text-pink-500 mb-3 flex items-center gap-2"><Icons.CalendarDays className="w-5 h-5" />×™×•× ×©×™×©×™</h4>
                                    {fridayTasks.map(task => <TaskItem key={task.id} task={task} childId={child.id} isDone={completedTasks[`${getTodayKey()}_${child.id}_${task.id}`]} onToggleTask={onToggleTask} onDeleteTask={onDeleteTask} onEditTask={onEditTask} onMoveTask={onMoveTask} />)}
                                </div>
                            )}

                            {/* EVENING / REST */}
                            {(otherTasks.length > 0 || tasks.length === 0) && (
                                <div>
                                    <h4 className="text-lg font-bold text-indigo-500 mb-3 flex items-center gap-2"><Icons.Moon className="w-5 h-5" />×¢×¨×‘ / ×›×œ×œ×™</h4>
                                    {otherTasks.map(task => <TaskItem key={task.id} task={task} childId={child.id} isDone={completedTasks[`${getTodayKey()}_${child.id}_${task.id}`]} onToggleTask={onToggleTask} onDeleteTask={onDeleteTask} onEditTask={onEditTask} onMoveTask={onMoveTask} />)}
                                    {tasks.length === 0 && <p className="text-center text-gray-400">××™×Ÿ ××©×™××•×ª ×œ×”×™×•×</p>}
                                </div>
                            )}

                            {tasks.length > 0 && tasks.every((t) => completedTasks[`${getTodayKey()}_${child.id}_${t.id}`]) && (
                                <div className="mt-6 text-center bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-yellow-800 animate-pulse">
                                    <Icons.Star className="w-8 h-8 mx-auto mb-2 text-yellow-500 fill-yellow-500" /><p className="font-bold text-lg">×›×œ ×”×›×‘×•×“! ×¡×™×™××ª ××ª ×›×œ ×”××©×™××•×ª ×œ×”×™×•×!</p>
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50">
                            {!isAdding ? (
                                <button onClick={() => setIsAdding(true)} className="w-full py-3 rounded-xl border-2 border-dashed border-slate-300 text-slate-500 font-bold hover:bg-white hover:border-blue-400 hover:text-blue-500 transition-all flex items-center justify-center gap-2"><Icons.Plus className="w-5 h-5" />×”×•×¡×£ ××©×™××” ×—×“×©×”</button>
                            ) : (
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm animate-fade-in">
                                    <input type="text" placeholder="×©× ×”××©×™××”..." value={newTaskText} onChange={(e) => setNewTaskText(e.target.value)} className="w-full p-3 rounded-lg border border-slate-300 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-200" autoFocus />
                                    <div className="grid grid-cols-2 gap-2 mb-3">
                                        <button onClick={() => setNewTaskType('morning')} className={`py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border ${newTaskType === 'morning' ? 'bg-orange-100 text-orange-700 border-orange-300' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><Icons.Sunrise className="w-4 h-4" />×›×œ ×‘×•×§×¨</button>
                                        <button onClick={() => setNewTaskType('evening')} className={`py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border ${newTaskType === 'evening' ? 'bg-indigo-100 text-indigo-700 border-indigo-300' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><Icons.Moon className="w-4 h-4" />×›×œ ×¢×¨×‘</button>
                                        <button onClick={() => setNewTaskType('friday')} className={`py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border ${newTaskType === 'friday' ? 'bg-pink-100 text-pink-700 border-pink-300' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><Icons.CalendarDays className="w-4 h-4" />×™×•× ×©×™×©×™</button>
                                        <button onClick={() => setNewTaskType('one-time')} className={`py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border ${newTaskType === 'one-time' ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><Icons.Calendar className="w-4 h-4" />×¨×§ ×œ×”×™×•×</button>
                                    </div>
                                    <label className="flex items-center gap-2 mb-4 p-2 bg-slate-50 rounded-lg cursor-pointer">
                                        <input type="checkbox" checked={addToAll} onChange={(e) => setAddToAll(e.target.checked)} className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300" />
                                        <span className="text-sm font-bold text-slate-600">×”×•×¡×£ ×œ×›×œ ×”×™×œ×“×™×</span>
                                    </label>
                                    <div className="flex gap-2">
                                        <button onClick={() => setIsAdding(false)} className="flex-1 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg">×‘×™×˜×•×œ</button>
                                        <button onClick={handleAddSubmit} className="flex-1 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md">×©××•×¨</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const EditChildModal = ({ childId, initialSettings, currentSettings, childName, onClose, onSave }) => {
            const getInitialTab = () => { if (currentSettings.useImage) return 'image'; if (currentSettings.useEmoji) return 'emoji'; return 'icon'; };
            const [activeTab, setActiveTab] = useState(getInitialTab());
            const [selectedThemeId, setSelectedThemeId] = useState(currentSettings.themeId || initialSettings.theme.id);
            const [selectedIconKey, setSelectedIconKey] = useState(currentSettings.iconKey || Object.keys(ICON_MAP).find(key => ICON_MAP[key] === initialSettings.IconComponent) || 'smile');
            const [customEmoji, setCustomEmoji] = useState(currentSettings.emoji || initialSettings.emoji);
            const [customImage, setCustomImage] = useState(currentSettings.image || initialSettings.image);
            const [customName, setCustomName] = useState(currentSettings.name || initialSettings.name);
            const [isProcessingImage, setIsProcessingImage] = useState(false);

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    setIsProcessingImage(true);
                    try { const resizedBase64 = await resizeImage(file); setCustomImage(resizedBase64); } catch (err) { console.error("Image processing error", err); } finally { setIsProcessingImage(false); }
                }
            };
            const handleSave = () => { onSave(childId, { themeId: selectedThemeId, useEmoji: activeTab === 'emoji', useImage: activeTab === 'image', iconKey: selectedIconKey, emoji: customEmoji || 'ğŸ˜Š', image: customImage || null, name: customName }); };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 className="text-xl font-bold text-slate-800">×¢×¨×™×›×ª ×¤×¨×˜×™ ×™×œ×“</h3><button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><Icons.X className="w-5 h-5" /></button></div>
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="mb-6"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Type className="w-5 h-5 text-slate-500" />×©× ×”×™×œ×“</h4><input type="text" value={customName} onChange={(e) => setCustomName(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none text-lg" placeholder="×”×›× ×¡ ×©×..." /></div>
                            <div className="mb-8"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Palette className="w-5 h-5 text-purple-500" />×‘×—×¨ ×¦×‘×¢</h4><div className="flex flex-wrap gap-3">{THEMES.map(theme => (<button key={theme.id} onClick={() => setSelectedThemeId(theme.id)} className={`w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all ${theme.classes.split(' ')[0]} ${selectedThemeId === theme.id ? 'border-slate-800 scale-110 shadow-md ring-2 ring-slate-200' : 'border-transparent'}`}>{selectedThemeId === theme.id && <Icons.Check className={`w-5 h-5 ${theme.classes.split(' ')[1]}`} />}</button>))}</div></div>
                            <div>
                                <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Smile className="w-5 h-5 text-orange-500" />×‘×—×¨ ×¡××œ, ××™××•×’'×™ ××• ×ª××•× ×”</h4>
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-4"><button onClick={() => setActiveTab('icon')} className={`flex-1 py-2 rounded-lg font-medium transition-all ${activeTab === 'icon' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>×¡××œ×™×</button><button onClick={() => setActiveTab('emoji')} className={`flex-1 py-2 rounded-lg font-medium transition-all ${activeTab === 'emoji' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>××™××•×’'×™</button><button onClick={() => setActiveTab('image')} className={`flex-1 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${activeTab === 'image' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}><Icons.Camera className="w-4 h-4" />×ª××•× ×”</button></div>
                                {activeTab === 'icon' && (<div className="grid grid-cols-5 gap-3">{Object.entries(ICON_MAP).map(([key, IconCmp]) => (<button key={key} onClick={() => setSelectedIconKey(key)} className={`aspect-square rounded-xl flex items-center justify-center border-2 transition-all ${selectedIconKey === key ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-slate-200 text-slate-400 hover:border-blue-200'}`}><IconCmp className="w-6 h-6" /></button>))}</div>)}
                                {activeTab === 'emoji' && (<div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200"><label className="text-sm text-slate-500 mb-2">×”×§×œ×“ ××• ×”×“×‘×§ ××™××•×’'×™ ×›××Ÿ:</label><input type="text" value={customEmoji} onChange={(e) => setCustomEmoji(e.target.value)} className="w-24 h-24 text-center text-6xl rounded-2xl border-2 border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none bg-white" maxLength={2} /></div>)}
                                {activeTab === 'image' && (<div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200"><div className="relative w-32 h-32 mb-4 group cursor-pointer">{customImage ? (<img src={customImage} alt="Preview" className="w-full h-full object-cover rounded-full border-4 border-white shadow-md" />) : (<div className="w-full h-full rounded-full bg-slate-200 flex items-center justify-center border-4 border-white shadow-md"><Icons.ImageIcon className="w-10 h-10 text-slate-400" /></div>)}<label htmlFor="file-upload" className="absolute inset-0 flex items-center justify-center bg-black/30 text-white opacity-0 group-hover:opacity-100 rounded-full transition-opacity cursor-pointer"><Icons.Upload className="w-8 h-8" /></label><input id="file-upload" type="file" accept="image/*" onChange={handleImageUpload} className="hidden" /></div>{isProcessingImage ? (<p className="text-sm text-blue-500 animate-pulse">××¢×‘×“ ×ª××•× ×”...</p>) : (<label htmlFor="file-upload" className="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 cursor-pointer">×‘×—×¨ ×ª××•× ×”</label>)}<p className="text-xs text-slate-400 mt-2 text-center">×‘×—×¨ ×ª××•× ×” ××”××›×©×™×¨. ×”×ª××•× ×” ×ª×•×§×˜×Ÿ ××•×˜×•××˜×™×ª.</p></div>)}
                            </div>
                        </div>
                        <div className="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3"><button onClick={onClose} className="px-5 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-colors">×‘×™×˜×•×œ</button><button onClick={handleSave} className="px-8 py-2.5 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">×©××•×¨ ×©×™× ×•×™×™×</button></div>
                    </div>
                </div>
            );
        };

        const EditFamilyModal = ({ initialSettings, currentSettings, onClose, onSave }) => {
            const getInitialTab = () => { if (currentSettings.useImage) return 'image'; if (currentSettings.useEmoji) return 'emoji'; return 'icon'; };
            const [activeTab, setActiveTab] = useState(getInitialTab());
            const [selectedThemeId, setSelectedThemeId] = useState(currentSettings.themeId || initialSettings.theme.id);
            const [selectedIconKey, setSelectedIconKey] = useState(currentSettings.iconKey || 'trophy');
            const [customEmoji, setCustomEmoji] = useState(currentSettings.emoji || 'ğŸ†');
            const [customImage, setCustomImage] = useState(currentSettings.image || null);
            const [customTitle, setCustomTitle] = useState(currentSettings.title || initialSettings.title);
            const [customTarget, setCustomTarget] = useState(currentSettings.targetPoints || FAMILY_DEFAULT.defaultTarget);
            const [customPointsPerShekel, setCustomPointsPerShekel] = useState(currentSettings.pointsPerShekel || FAMILY_DEFAULT.defaultPointsPerShekel);
            const [customPin, setCustomPin] = useState(currentSettings.parentPin || "");
            const [isProcessingImage, setIsProcessingImage] = useState(false);

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                setIsProcessingImage(true);
                try { const resizedBase64 = await resizeImage(file); setCustomImage(resizedBase64); } catch (err) { console.error("Image processing error", err); } finally { setIsProcessingImage(false); }
                }
            };

            const handleSave = () => {
                onSave({
                    themeId: selectedThemeId,
                    useEmoji: activeTab === 'emoji',
                    useImage: activeTab === 'image',
                    iconKey: selectedIconKey,
                    emoji: customEmoji || 'ğŸ†',
                    image: customImage || null,
                    title: customTitle,
                    targetPoints: Number(customTarget),
                    pointsPerShekel: Number(customPointsPerShekel),
                    parentPin: customPin // Save PIN
                });
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                    <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 className="text-xl font-bold text-slate-800">×¢×¨×™×›×ª ×›×•×ª×¨×ª ×•×¡××œ</h3><button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><Icons.X className="w-5 h-5" /></button></div>
                    <div className="p-6 overflow-y-auto flex-1">
                        <div className="mb-6"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Type className="w-5 h-5 text-slate-500" />×›×•×ª×¨×ª ×”××¤×œ×™×§×¦×™×”</h4><input type="text" value={customTitle} onChange={(e) => setCustomTitle(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none text-lg" placeholder="×”×›× ×¡ ×›×•×ª×¨×ª..." /></div>
                        <div className="mb-6"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Target className="w-5 h-5 text-slate-500" />×™×¢×“ × ×§×•×“×•×ª</h4><input type="number" value={customTarget} onChange={(e) => setCustomTarget(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none text-lg" placeholder="100" min="1" /></div>
                        <div className="mb-6"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Coins className="w-5 h-5 text-slate-500" />×›××” × ×§×•×“×•×ª ×©×•×•×ª ×©×§×œ?</h4><input type="number" value={customPointsPerShekel} onChange={(e) => setCustomPointsPerShekel(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none text-lg" placeholder="5" min="1" /></div>
                        <div className="mb-6"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Lock className="w-5 h-5 text-slate-500" />×§×•×“ ×”×•×¨×™× (××•×¤×¦×™×•× ×œ×™)</h4><input type="text" maxLength="4" value={customPin} onChange={(e) => setCustomPin(e.target.value.replace(/\D/g, ''))} className="w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none text-lg tracking-widest text-center" placeholder="×”×’×“×¨ ×§×•×“ (4 ×¡×¤×¨×•×ª)" /><p className="text-xs text-slate-400 mt-1">×”×©××¨ ×¨×™×§ ×›×“×™ ×œ×‘×˜×œ × ×¢×™×œ×”</p></div>
                        <div className="mb-8"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Palette className="w-5 h-5 text-purple-500" />×‘×—×¨ ×¦×‘×¢</h4><div className="flex flex-wrap gap-3">{THEMES.map(theme => (<button key={theme.id} onClick={() => setSelectedThemeId(theme.id)} className={`w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all ${theme.classes.split(' ')[0]} ${selectedThemeId === theme.id ? 'border-slate-800 scale-110 shadow-md ring-2 ring-slate-200' : 'border-transparent'}`}>{selectedThemeId === theme.id && <Icons.Check className={`w-5 h-5 ${theme.classes.split(' ')[1]}`} />}</button>))}</div></div>
                        <div>
                            <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Smile className="w-5 h-5 text-orange-500" />×‘×—×¨ ×¡××œ, ××™××•×’'×™ ××• ×ª××•× ×”</h4>
                            <div className="flex bg-slate-100 p-1 rounded-xl mb-4"><button onClick={() => setActiveTab('icon')} className={`flex-1 py-2 rounded-lg font-medium transition-all ${activeTab === 'icon' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>×¡××œ×™×</button><button onClick={() => setActiveTab('emoji')} className={`flex-1 py-2 rounded-lg font-medium transition-all ${activeTab === 'emoji' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>××™××•×’'×™</button><button onClick={() => setActiveTab('image')} className={`flex-1 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${activeTab === 'image' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}><Icons.Camera className="w-4 h-4" />×ª××•× ×”</button></div>
                            {activeTab === 'icon' && (<div className="grid grid-cols-5 gap-3">{Object.entries(ICON_MAP).map(([key, IconCmp]) => (<button key={key} onClick={() => setSelectedIconKey(key)} className={`aspect-square rounded-xl flex items-center justify-center border-2 transition-all ${selectedIconKey === key ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-slate-200 text-slate-400 hover:border-blue-200'}`}><IconCmp className="w-6 h-6" /></button>))}</div>)}
                            {activeTab === 'emoji' && (<div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200"><label className="text-sm text-slate-500 mb-2">×”×§×œ×“ ××• ×”×“×‘×§ ××™××•×’'×™ ×›××Ÿ:</label><input type="text" value={customEmoji} onChange={(e) => setCustomEmoji(e.target.value)} className="w-24 h-24 text-center text-6xl rounded-2xl border-2 border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none bg-white" maxLength={2} /></div>)}
                            {activeTab === 'image' && (<div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200"><div className="relative w-32 h-32 mb-4 group cursor-pointer">{customImage ? (<img src={customImage} alt="Preview" className="w-full h-full object-cover rounded-full border-4 border-white shadow-md" />) : (<div className="w-full h-full rounded-full bg-slate-200 flex items-center justify-center border-4 border-white shadow-md"><Icons.ImageIcon className="w-10 h-10 text-slate-400" /></div>)}<label htmlFor="file-upload" className="absolute inset-0 flex items-center justify-center bg-black/30 text-white opacity-0 group-hover:opacity-100 rounded-full transition-opacity cursor-pointer"><Icons.Upload className="w-8 h-8" /></label><input id="file-upload" type="file" accept="image/*" onChange={handleImageUpload} className="hidden" /></div>{isProcessingImage ? (<p className="text-sm text-blue-500 animate-pulse">××¢×‘×“ ×ª××•× ×”...</p>) : (<label htmlFor="file-upload" className="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 cursor-pointer">×‘×—×¨ ×ª××•× ×”</label>)}<p className="text-xs text-slate-400 mt-2 text-center">×‘×—×¨ ×ª××•× ×” ××”××›×©×™×¨. ×”×ª××•× ×” ×ª×•×§×˜×Ÿ ××•×˜×•××˜×™×ª.</p></div>)}
                        </div>
                    </div>
                    <div className="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3"><button onClick={onClose} className="px-5 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-colors">×‘×™×˜×•×œ</button><button onClick={handleSave} className="px-8 py-2.5 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">×©××•×¨ ×©×™× ×•×™×™×</button></div>
                </div>
                </div>
            );
        };

        const AddChildModal = ({ onClose, onSave }) => {
            const [name, setName] = useState("");
            const [selectedThemeId, setSelectedThemeId] = useState("yellow");
            const [selectedIconKey, setSelectedIconKey] = useState("smile");

            const handleSave = () => {
                if (!name.trim()) return;
                onSave({ name, defaultThemeId: selectedThemeId, defaultIconKey: selectedIconKey });
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 className="text-xl font-bold text-slate-800">×”×•×¡×¤×ª ×™×œ×“ ×—×“×©</h3><button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><Icons.X className="w-5 h-5" /></button></div>
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="mb-6"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Type className="w-5 h-5 text-slate-500" />×©× ×”×™×œ×“</h4><input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none text-lg" placeholder="×”×›× ×¡ ×©×..." autoFocus /></div>
                            <div className="mb-8"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Palette className="w-5 h-5 text-purple-500" />×‘×—×¨ ×¦×‘×¢</h4><div className="flex flex-wrap gap-3">{THEMES.map(theme => (<button key={theme.id} onClick={() => setSelectedThemeId(theme.id)} className={`w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all ${theme.classes.split(' ')[0]} ${selectedThemeId === theme.id ? 'border-slate-800 scale-110 shadow-md ring-2 ring-slate-200' : 'border-transparent'}`}>{selectedThemeId === theme.id && <Icons.Check className={`w-5 h-5 ${theme.classes.split(' ')[1]}`} />}</button>))}</div></div>
                            <div><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><Icons.Smile className="w-5 h-5 text-orange-500" />×‘×—×¨ ×¡××œ</h4><div className="grid grid-cols-5 gap-3">{Object.entries(ICON_MAP).map(([key, IconCmp]) => (<button key={key} onClick={() => setSelectedIconKey(key)} className={`aspect-square rounded-xl flex items-center justify-center border-2 transition-all ${selectedIconKey === key ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-slate-200 text-slate-400 hover:border-blue-200'}`}><IconCmp className="w-6 h-6" /></button>))}</div></div>
                        </div>
                        <div className="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3"><button onClick={onClose} className="px-5 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-colors">×‘×™×˜×•×œ</button><button onClick={handleSave} className="px-8 py-2.5 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">×©××•×¨</button></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true); // Loading state
            const [points, setPoints] = useState(0);
            const [completedTasks, setCompletedTasks] = useState({});
            const [childSettings, setChildSettings] = useState({});
            const [familySettings, setFamilySettings] = useState({});
            const [tasksData, setTasksData] = useState({});
            const [history, setHistory] = useState([]);
            const [childScores, setChildScores] = useState({});
            const [childrenList, setChildrenList] = useState(CHILDREN_DEFAULTS);

            const [selectedChild, setSelectedChild] = useState(null);
            const [editingChildId, setEditingChildId] = useState(null);
            const [showFamilyEditModal, setShowFamilyEditModal] = useState(false);
            const [showBonusModal, setShowBonusModal] = useState(false);
            const [showWinModal, setShowWinModal] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [showPinModal, setShowPinModal] = useState(false);
            const [showCashOutModal, setShowCashOutModal] = useState(false);
            const [showAddChildModal, setShowAddChildModal] = useState(false);
            const [cashOutChildId, setCashOutChildId] = useState(null);

            const [pendingAction, setPendingAction] = useState(null);
            const [animationClass, setAnimationClass] = useState('');
            const [showConfetti, setShowConfetti] = useState(false);
            const confettiTimeoutRef = useRef(null);
            const longPressTimer = useRef(null);
            const isLongPress = useRef(false);
            const targetPoints = familySettings.targetPoints || FAMILY_DEFAULT.defaultTarget;
            const pointsPerShekel = familySettings.pointsPerShekel || FAMILY_DEFAULT.defaultPointsPerShekel;
            const parentPin = familySettings.parentPin || null;
            const [currentDate, setCurrentDate] = useState('');
            const [hebrewDate, setHebrewDate] = useState('');

            // --- DATE SETUP ---
            useEffect(() => {
                const now = new Date();
                setCurrentDate(now.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' }));
                try {
                    const parts = new Intl.DateTimeFormat('he-IL', { calendar: 'hebrew', day: 'numeric', month: 'long', year: 'numeric' }).formatToParts(now);
                    const day = parts.find(p => p.type === 'day')?.value; const month = parts.find(p => p.type === 'month')?.value; const year = parts.find(p => p.type === 'year')?.value;
                    if (day && month && year) { setHebrewDate(`${toHebrewNumeral(parseInt(day, 10))} ${month} ${year}`); }
                } catch (e) { console.log("Hebrew cal error", e); }
            }, []);

            // --- AUTH & DATA LOADING ---
            useEffect(() => {
                const initAuth = async () => {
                    // Try to use the Canvas custom token if available (for instant login without popups)
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } catch (e) {
                            console.warn("Custom token failed, falling back to anonymous", e);
                            await auth.signInAnonymously();
                        }
                    } else {
                        // Otherwise, use Anonymous auth (works in local files and previews)
                        await auth.signInAnonymously();
                    }
                };
                
                initAuth();

                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setIsLoading(false);
                    
                    if (currentUser) {
                        // Use a safe path structure: artifacts/{appId}/users/{uid}
                        const docRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid);
                        
                        // Real-time listener
                        const unsubscribeDoc = docRef.onSnapshot((docSnap) => {
                            if (docSnap.exists) {
                                const data = docSnap.data();
                                setPoints(Number(data.points) || 0);
                                setCompletedTasks(data.completedTasks || {});
                                setChildSettings(data.childSettings || {});
                                setFamilySettings(data.familySettings || {});
                                setTasksData(data.childTasks || {});
                                setHistory(data.history || []);
                                setChildScores(data.childScores || {});
                                if (data.childrenList) setChildrenList(data.childrenList);
                            } else {
                                // Initialize new user data
                                docRef.set({ 
                                    points: 0, 
                                    completedTasks: {}, 
                                    childSettings: {}, 
                                    familySettings: {}, 
                                    childTasks: {}, 
                                    history: [], 
                                    childScores: {}, 
                                    childrenList: CHILDREN_DEFAULTS,
                                    ownerEmail: currentUser.email || 'anonymous'
                                });
                            }
                        }, (error) => {
                            console.error("Firestore Listen Error:", error);
                        });
                        return () => unsubscribeDoc();
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (points >= targetPoints && points > 0) setShowWinModal(true);
            }, [points, targetPoints]);

            const getTodayKey = () => { const d = new Date(); return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`; };
            const getChildVisuals = (childId) => {
                const childDefault = childrenList.find(c => c.id === childId) || CHILDREN_DEFAULTS.find(c => c.id === childId);
                if (!childDefault) return { theme: THEMES[0], IconComponent: Icons.Smile, useImage: false, image: null, name: 'Unknown' };

                const settings = childSettings[childId] || {};
                const themeId = settings.themeId || childDefault.defaultThemeId;
                const theme = THEMES.find(t => t.id === themeId) || THEMES[0];
                const useImage = settings.useImage; const image = settings.image; const useEmoji = settings.useEmoji; const emoji = settings.emoji || 'ğŸ˜Š'; const iconKey = settings.iconKey || childDefault.defaultIconKey;
                const IconComponent = ICON_MAP[iconKey] || Icons.Smile;
                const name = settings.name || childDefault.name;
                return { theme, IconComponent, useEmoji, emoji, useImage, image, name };
            };
            const getChildTasks = (childId) => {
                if (tasksData[childId]) {
                    const today = getTodayKey(); const dayOfWeek = new Date().getDay();
                    return tasksData[childId].filter(t => t.type === 'daily' || t.type === 'morning' || t.type === 'evening' || (t.type === 'one-time' && t.date === today) || (t.type === 'friday' && dayOfWeek === 5));
                }
                const childDefault = childrenList.find(c => c.id === childId);
                return childDefault ? (childDefault.initialTasks || []) : [];
            };
            const getFamilyVisuals = () => {
                const settings = familySettings || {}; const themeId = settings.themeId || FAMILY_DEFAULT.defaultThemeId;
                const theme = THEMES.find(t => t.id === themeId) || THEMES[0];
                const useImage = settings.useImage; const image = settings.image; const useEmoji = settings.useEmoji; const emoji = settings.emoji || 'ğŸ†';
                const iconKey = settings.iconKey || FAMILY_DEFAULT.defaultIconKey; const IconComponent = ICON_MAP[iconKey] || Icons.Trophy;
                const title = settings.title || FAMILY_DEFAULT.defaultTitle;
                return { theme, IconComponent, useEmoji, emoji, useImage, image, title };
            };

            // --- ACTIONS ---
            const verifyParentAuth = (callback) => {
                if (!parentPin) { callback(); } else { setPendingAction(() => callback); setShowPinModal(true); }
            };
            const handlePinSuccess = () => { setShowPinModal(false); if (pendingAction) { pendingAction(); setPendingAction(null); } };

            const addToHistoryLog = async (text, pointsDiff) => {
                if (!user) return;
                const newEntry = { text, diff: pointsDiff, timestamp: Date.now() };
                const updatedHistory = [newEntry, ...history].slice(0, 50);
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                await docRef.update({ history: updatedHistory });
            };

            const handleDeleteHistoryEntry = (index) => {
                verifyParentAuth(async () => {
                    if (!user) return;
                    const item = history[index];
                    const newHistory = [...history];
                    newHistory.splice(index, 1);
                    const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                    await docRef.update({ 
                        history: newHistory,
                        points: firebase.firestore.FieldValue.increment(-item.diff)
                    });
                });
            };

            const triggerConfetti = () => {
                setAnimationClass('scale-110'); setTimeout(() => setAnimationClass(''), 200); setShowConfetti(true);
                if (confettiTimeoutRef.current) clearTimeout(confettiTimeoutRef.current);
                confettiTimeoutRef.current = setTimeout(() => setShowConfetti(false), 3000);
            };

            const handleTaskToggle = async (childId, taskId, taskText) => {
                if (!user) return;
                const taskKey = `${getTodayKey()}_${childId}_${taskId}`;
                const isAlreadyDone = completedTasks[taskKey];
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                const childName = getChildVisuals(childId).name;
                
                const updates = {};
                
                if (isAlreadyDone) {
                    updates.points = firebase.firestore.FieldValue.increment(-1);
                    updates[`completedTasks.${taskKey}`] = false;
                    updates[`childScores.${childId}`] = firebase.firestore.FieldValue.increment(-1);
                    await docRef.update(updates);
                    addToHistoryLog(`×‘×™×˜×•×œ: ${taskText || '××©×™××”'} (${childName})`, -1);
                } else {
                    playSuccessSound(); triggerConfetti();
                    updates.points = firebase.firestore.FieldValue.increment(1);
                    updates[`completedTasks.${taskKey}`] = true;
                    updates[`childScores.${childId}`] = firebase.firestore.FieldValue.increment(1);
                    await docRef.update(updates);
                    addToHistoryLog(`××©×™××”: ${taskText || '××©×™××”'} (${childName})`, 1);
                }
            };

            const handleAddTask = async (childId, newTaskText, taskType, addToAll) => {
                if (!user) return;
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                let updates = {};
                const childrenToUpdate = addToAll ? childrenList.map(c => c.id) : [childId];
                childrenToUpdate.forEach(cid => {
                    const currentTasks = tasksData[cid] || (childrenList.find(c => c.id === cid)?.initialTasks || []);
                    const newTask = { id: `custom_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, text: newTaskText, type: taskType, date: getTodayKey(), createdAt: Date.now() };
                    updates[`childTasks.${cid}`] = [...currentTasks, newTask];
                });
                await docRef.update(updates);
            };

            const handleEditTask = async (childId, taskId, newText, newType) => {
                verifyParentAuth(async () => {
                    if (!user) return;
                    const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                    const currentTasks = tasksData[childId] || (childrenList.find(c => c.id === childId)?.initialTasks || []);
                    const updatedTasks = currentTasks.map(t => 
                        t.id === taskId ? { 
                            ...t, 
                            text: newText, 
                            type: newType,
                            date: newType === 'one-time' ? getTodayKey() : t.date 
                        } : t
                    );
                    await docRef.update({ [`childTasks.${childId}`]: updatedTasks });
                });
            };

            const handleMoveTask = async (childId, taskId, direction) => {
                if (!user) return;
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                const currentTasks = [...(tasksData[childId] || (childrenList.find(c => c.id === childId)?.initialTasks || []))];
                const index = currentTasks.findIndex(t => t.id === taskId);
                if (index < 0) return;
                if (direction === 'up' && index > 0) {
                    [currentTasks[index], currentTasks[index - 1]] = [currentTasks[index - 1], currentTasks[index]];
                } else if (direction === 'down' && index < currentTasks.length - 1) {
                    [currentTasks[index], currentTasks[index + 1]] = [currentTasks[index + 1], currentTasks[index]];
                }
                await docRef.update({ [`childTasks.${childId}`]: currentTasks });
            };

            const handleDeleteTask = async (childId, taskId) => {
                verifyParentAuth(async () => {
                    if (!user) return;
                    const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                    const currentTasks = tasksData[childId] || (childrenList.find(c => c.id === childId)?.initialTasks || []);
                    const updatedChildTasks = { ...tasksData, [childId]: currentTasks.filter(t => t.id !== taskId) };
                    await docRef.update({ childTasks: updatedChildTasks });
                });
            };

            const handleBonusPoint = async (amount = 1, childId = null) => {
                if (!user) return; playSuccessSound(); triggerConfetti();
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                const updates = { points: firebase.firestore.FieldValue.increment(amount) };
                let logMessage = `×‘×•× ×•×¡ ××©×¤×—×ª×™`;
                if (childId) {
                    updates[`childScores.${childId}`] = firebase.firestore.FieldValue.increment(amount);
                    const childName = getChildVisuals(childId).name;
                    logMessage = `×‘×•× ×•×¡ ×œ${childName}`;
                }
                await docRef.update(updates);
                addToHistoryLog(logMessage, amount);
                setShowBonusModal(false);
            };

            const handleSaveSettings = async (childId, newSettings) => {
                if (!user) return;
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                await docRef.update({ childSettings: { ...childSettings, [childId]: { ...childSettings[childId], ...newSettings } } });
                setEditingChildId(null);
            };

            const handleSaveFamilySettings = async (newSettings) => {
                if (!user) return;
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                await docRef.update({ familySettings: newSettings });
                setShowFamilyEditModal(false);
            };

            const handleResetPoints = async () => {
                verifyParentAuth(async () => {
                    if (!user) return;
                    const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                    await docRef.update({ points: 0, childScores: {} });
                    addToHistoryLog('××™×¤×•×¡ × ×§×•×“×•×ª', -points);
                    setShowWinModal(false);
                });
            };
            
            const handleCashOut = async (amount) => {
                if (!user || !cashOutChildId) return;
                const pointsToDeduct = amount * pointsPerShekel;
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                const childName = getChildVisuals(cashOutChildId).name;
                await docRef.update({ [`childScores.${cashOutChildId}`]: firebase.firestore.FieldValue.increment(-pointsToDeduct) });
                addToHistoryLog(`×¤×“×™×•×Ÿ ×›×¡×£ ×¢×‘×•×¨ ${childName}: â‚ª${amount}`, 0); 
                setShowCashOutModal(false);
                setCashOutChildId(null);
            };

            const handleAddChild = async (newChildData) => {
                if (!user) return;
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                const newChildId = `child_${Date.now()}`;
                const newChild = {
                    id: newChildId,
                    name: newChildData.name,
                    defaultThemeId: newChildData.defaultThemeId,
                    defaultIconKey: newChildData.defaultIconKey,
                    initialTasks: getStandardTasks(newChildId)
                };
                const updatedList = [...childrenList, newChild];
                await docRef.update({ childrenList: updatedList });
                setShowAddChildModal(false);
            };

            const handleLogout = () => {
                auth.signOut();
                setUser(null);
            };

            const createLongPressHandlers = (callback, onClick) => ({
                onMouseDown: () => { isLongPress.current = false; longPressTimer.current = setTimeout(() => { isLongPress.current = true; verifyParentAuth(callback); }, 800); },
                onMouseUp: (e) => { if (longPressTimer.current) clearTimeout(longPressTimer.current); if (!isLongPress.current && onClick) onClick(e); },
                onMouseLeave: () => { if (longPressTimer.current) clearTimeout(longPressTimer.current); },
                onTouchStart: () => { isLongPress.current = false; longPressTimer.current = setTimeout(() => { isLongPress.current = true; verifyParentAuth(callback); }, 800); },
                onTouchEnd: (e) => { if (longPressTimer.current) clearTimeout(longPressTimer.current); if (isLongPress.current) e.preventDefault(); if (!isLongPress.current && onClick) onClick(e); }
            });

            // Weekly Chart Logic
            const weeklyChartData = useMemo(() => {
                if (!history.length) return [];
                const days = {};
                // Get last 7 days
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const key = d.toLocaleDateString('he-IL'); // Key for display
                    days[key] = { date: key, points: 0, dayName: d.toLocaleDateString('he-IL', {weekday: 'short'}) };
                }
                
                // Aggregate points
                history.forEach(item => {
                    const itemDate = new Date(item.timestamp).toLocaleDateString('he-IL');
                    if (days[itemDate] && item.diff > 0) {
                        days[itemDate].points += item.diff;
                    }
                });
                return Object.values(days);
            }, [history]);

            if (isLoading) {
                return (
                    <div className="flex h-screen items-center justify-center bg-slate-50">
                        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                    </div>
                );
            }

            if (!user) {
                return <LoginScreen />;
            }

            const progressPercent = Math.min((points / targetPoints) * 100, 100);
            const familyVisuals = getFamilyVisuals();

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800" dir="rtl">
                    {(showConfetti || showWinModal) && <Confetti density={showWinModal ? 400 : 150} />}
                    <header className="bg-white shadow-lg p-6 sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-3 select-none w-full md:w-auto justify-between md:justify-start">
                                <div className="flex items-center gap-3">
                                    <div className={`p-3 rounded-full transition-transform ${familyVisuals.theme.classes.split(' ')[0]} ${familyVisuals.theme.classes.split(' ')[2].replace('border', 'border-2')}`}>
                                        <div className="w-8 h-8 flex items-center justify-center overflow-hidden rounded-full">{familyVisuals.useImage && familyVisuals.image ? <img src={familyVisuals.image} alt="Family" className="w-full h-full object-cover" /> : familyVisuals.useEmoji ? <span className="text-2xl leading-none">{familyVisuals.emoji}</span> : <familyVisuals.IconComponent className={`w-8 h-8 ${familyVisuals.theme.iconText}`} />}</div>
                                    </div>
                                    <div><h1 className="text-2xl font-bold text-slate-800">{familyVisuals.title}</h1><div className="text-slate-500 text-sm flex gap-2"><span>{currentDate}</span>{hebrewDate && <span className="border-r border-slate-300 pr-2">{hebrewDate}</span>}</div></div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => verifyParentAuth(() => setShowFamilyEditModal(true))} className="p-2 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 transition-colors" title="×”×’×“×¨×•×ª ×”×•×¨×™×"><Icons.Settings className="w-6 h-6" /></button>
                                    <button onClick={() => setShowHistoryModal(true)} className="p-2 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 transition-colors" title="×”×™×¡×˜×•×¨×™×”"><Icons.BarChart className="w-6 h-6" /></button>
                                    <button onClick={handleLogout} className="p-2 rounded-full bg-slate-100 hover:bg-red-100 text-slate-500 hover:text-red-500 transition-colors" title="×”×ª× ×ª×§"><Icons.Unlock className="w-6 h-6" /></button>
                                </div>
                            </div>
                            <div className="flex-1 w-full md:w-auto md:mx-8">
                                <div className="flex justify-between mb-2 text-lg font-bold"><span className={`transition-transform duration-300 ${animationClass} text-blue-600`}>{points} × ×§×•×“×•×ª</span><span className="text-slate-400">×™×¢×“: {targetPoints}</span></div>
                                <div className="h-6 w-full bg-slate-200 rounded-full overflow-hidden shadow-inner"><div className="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-700 ease-out flex items-center justify-center relative" style={{ width: `${progressPercent}%` }}>{progressPercent > 10 && (<div className="absolute left-0 top-0 bottom-0 w-full animate-[shimmer_2s_infinite] bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12"></div>)}</div></div>
                            </div>
                            <button onClick={() => verifyParentAuth(() => setShowBonusModal(true))} className="flex items-center gap-2 bg-gradient-to-r from-orange-400 to-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:shadow-lg transform active:scale-95 transition-all w-full md:w-auto justify-center"><Icons.Sparkles className="w-5 h-5" /><span>×‘×•× ×•×¡</span></button>
                        </div>
                    </header>
                    <main className="max-w-6xl mx-auto p-6"><div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mt-4">
                        {childrenList.map((child) => {
                            const { theme, IconComponent, useEmoji, emoji, useImage, image, name } = getChildVisuals(child.id);
                            const currentTasks = getChildTasks(child.id);
                            const currentScore = childScores[child.id] || 0;
                            const money = Math.floor(currentScore / pointsPerShekel);

                            const completedCount = currentTasks.filter(t => completedTasks[`${getTodayKey()}_${child.id}_${t.id}`]).length;
                            const totalCount = currentTasks.length;
                            const childProgress = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

                            return (
                                <div key={child.id} className={`group relative bg-white rounded-3xl p-6 border-4 ${theme.classes.split(' ')[2]} shadow-md hover:shadow-xl hover:-translate-y-2 transition-all duration-300 flex flex-col items-center justify-center gap-4 h-64 select-none`} {...createLongPressHandlers(() => setEditingChildId(child.id), () => setSelectedChild(child))}>
                                    <button onClick={(e) => { e.stopPropagation(); verifyParentAuth(() => setEditingChildId(child.id)); }} className="absolute top-2 right-2 p-2 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-colors opacity-0 group-hover:opacity-100 z-10" title="×¢×¨×™×›×ª ×¢×™×¦×•×‘"><Icons.Settings className="w-4 h-4" /></button>
                                    
                                    <div className="absolute top-0 left-0 -mt-3 -ml-3 bg-gradient-to-br from-yellow-400 to-orange-500 text-white w-10 h-10 flex items-center justify-center rounded-full shadow-lg font-bold border-2 border-white z-20">
                                        {currentScore}
                                    </div>
                                    
                                    <button onClick={(e) => { e.stopPropagation(); setCashOutChildId(child.id); verifyParentAuth(() => setShowCashOutModal(true)); }} className="absolute top-0 left-9 -mt-3 ml-1 bg-gradient-to-br from-green-400 to-emerald-600 text-white w-12 h-8 flex items-center justify-center rounded-full shadow-lg font-bold border-2 border-white z-20 gap-0.5 text-sm hover:scale-110 transition-transform">â‚ª{money}</button>

                                    <div className="flex flex-col items-center justify-center w-full h-full cursor-pointer mt-2">
                                        <div className={`w-20 h-20 rounded-full ${theme.iconBg} flex items-center justify-center shadow-inner group-hover:scale-110 transition-transform overflow-hidden relative border-4 border-white`}>{useImage && image ? <img src={image} alt={name} className="w-full h-full object-cover" /> : useEmoji ? <span className="text-4xl leading-none select-none">{emoji}</span> : <IconComponent className={`w-10 h-10 ${theme.iconText}`} />}</div>
                                        <h2 className="text-2xl font-bold text-center mt-3" title="×œ×—×™×¦×” ××¨×•×›×” ×œ×¢×¨×™×›×ª ×©×">{name}</h2>
                                        
                                        {/* Visual Progress Bar */}
                                        <div className="w-full mt-3 px-4">
                                            <div className="flex justify-between text-xs text-slate-400 font-bold mb-1">
                                                <span>×”×•×©×œ×</span>
                                                <span>{completedCount}/{totalCount}</span>
                                            </div>
                                            <div className="h-3 w-full bg-slate-100 rounded-full overflow-hidden">
                                                <div 
                                                    className={`h-full transition-all duration-500 ease-out rounded-full ${childProgress === 100 ? 'bg-green-500' : 'bg-blue-500'}`} 
                                                    style={{ width: `${childProgress}%` }}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="absolute top-4 left-4 bg-slate-100 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"><Icons.Plus className="w-5 h-5 text-slate-400" /></div>
                                </div>
                            );
                        })}
                        {/* ADD CHILD CARD */}
                        <button onClick={() => verifyParentAuth(() => setShowAddChildModal(true))} className="group relative bg-slate-50 border-4 border-dashed border-slate-300 rounded-3xl p-6 shadow-sm hover:shadow-lg hover:border-slate-400 hover:-translate-y-2 transition-all duration-300 flex flex-col items-center justify-center gap-4 h-64">
                            <div className="w-20 h-20 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 group-hover:bg-slate-300 group-hover:text-slate-600 transition-colors">
                                <Icons.UserPlus className="w-10 h-10" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-400 group-hover:text-slate-600">×”×•×¡×£ ×™×œ×“</h2>
                        </button>
                    </div></main>
                    {selectedChild && <TaskModal child={selectedChild} tasks={getChildTasks(selectedChild.id)} completedTasks={completedTasks} visuals={getChildVisuals(selectedChild.id)} onToggleTask={handleTaskToggle} onClose={() => setSelectedChild(null)} onAddTask={handleAddTask} onDeleteTask={handleDeleteTask} onEditTask={handleEditTask} onMoveTask={handleMoveTask} getTodayKey={getTodayKey} />}
                    {editingChildId && <EditChildModal childId={editingChildId} initialSettings={getChildVisuals(editingChildId)} currentSettings={childSettings[editingChildId] || {}} onClose={() => setEditingChildId(null)} onSave={handleSaveSettings} childName={childrenList.find(c => c.id === editingChildId)?.name} />}
                    {showFamilyEditModal && <EditFamilyModal initialSettings={getFamilyVisuals()} currentSettings={familySettings} onClose={() => setShowFamilyEditModal(false)} onSave={handleSaveFamilySettings} />}
                    {showBonusModal && <BonusModal onClose={() => setShowBonusModal(false)} onConfirm={handleBonusPoint} childrenData={childrenList} childSettings={childSettings} />}
                    {showWinModal && (<div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md animate-fade-in"><div className="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl p-8 text-center animate-scale-up border-8 border-yellow-300 relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-32 bg-yellow-100 rounded-b-[50%] -translate-y-16"></div><div className="relative z-10"><div className="mx-auto w-32 h-32 bg-gradient-to-b from-yellow-300 to-yellow-500 rounded-full flex items-center justify-center mb-6 shadow-xl border-4 border-white animate-bounce"><Icons.Trophy className="w-16 h-16 text-white drop-shadow-md" /></div><h2 className="text-5xl font-black text-slate-800 mb-2 tracking-tight">×›×œ ×”×›×‘×•×“!</h2><h3 className="text-2xl font-bold text-slate-600 mb-6">×”×’×¢×ª× ×œ×™×¢×“ ×©×œ {targetPoints} × ×§×•×“×•×ª!</h3><div className="p-4 bg-yellow-50 rounded-2xl mb-8 border-2 border-yellow-200"><p className="text-yellow-800 text-lg">"×™×’×¢×ª ×•××¦××ª ×ª×××™×Ÿ!"</p><p className="text-yellow-700 font-bold mt-1">×”××©×™×›×• ×›×š!</p></div><button onClick={handleResetPoints} className="w-full py-4 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold text-xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all flex items-center justify-center gap-2 group"><Icons.RotateCcw className="w-6 h-6 group-hover:rotate-180 transition-transform duration-500" />××¤×¡ × ×§×•×“×•×ª ×•×”×ª×—×œ ××—×“×©</button></div></div></div>)}
                    
                    {/* UPDATED HISTORY MODAL WITH CHART */}
                    {showHistoryModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl flex flex-col max-h-[85vh]">
                                <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icons.BarChart className="w-5 h-5 text-blue-500"/>×¤×¢×™×œ×•×ª ×”×©×‘×•×¢</h3>
                                    <button onClick={() => setShowHistoryModal(false)} className="p-2 hover:bg-slate-200 rounded-full"><Icons.X className="w-5 h-5" /></button>
                                </div>
                                <div className="overflow-y-auto p-4 flex-1">
                                    {/* WEEKLY CHART */}
                                    <div className="bg-slate-50 rounded-2xl p-4 mb-4 border border-slate-100">
                                        <h4 className="text-sm font-bold text-slate-500 mb-3 text-center">× ×§×•×“×•×ª ×‘-7 ×”×™××™× ×”××—×¨×•× ×™×</h4>
                                        <div className="flex justify-between items-end h-32 gap-2">
                                            {weeklyChartData.map((d, i) => {
                                                const maxPoints = Math.max(...weeklyChartData.map(d => d.points), 1);
                                                const height = (d.points / maxPoints) * 100;
                                                return (
                                                    <div key={i} className="flex flex-col items-center flex-1 gap-1">
                                                        <div className="w-full bg-blue-100 rounded-t-lg relative group transition-all hover:bg-blue-200" style={{ height: `${Math.max(height, 5)}%` }}>
                                                            {d.points > 0 && <span className="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-blue-600 bg-white shadow-sm px-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">{d.points}</span>}
                                                        </div>
                                                        <span className="text-[10px] font-bold text-slate-400">{d.dayName}</span>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>

                                    <h4 className="font-bold text-slate-700 mb-2">×¤×™×¨×•×˜ ×¤×¢×•×œ×•×ª ××—×¨×•× ×•×ª</h4>
                                    <div className="space-y-3">
                                        {history.length === 0 ? (<p className="text-center text-slate-400 py-6">××™×Ÿ ×¢×“×™×™×Ÿ ×”×™×¡×˜×•×¨×™×”</p>) : (history.map((item, i) => (
                                            <div key={i} className="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                                                <div className="flex-1">
                                                    <p className="font-bold text-slate-700 text-sm">{item.text}</p>
                                                    <p className="text-[10px] text-slate-400">{new Date(item.timestamp).toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit'})} â€¢ {new Date(item.timestamp).toLocaleDateString('he-IL')}</p>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className={`font-bold dir-ltr text-sm ${item.diff > 0 ? 'text-green-600' : 'text-red-500'}`}>{item.diff > 0 ? '+' : ''}{item.diff}</span>
                                                    <button onClick={() => handleDeleteHistoryEntry(i)} className="p-1.5 bg-red-50 text-red-400 rounded-lg hover:bg-red-100 hover:text-red-600 transition-colors"><Icons.Trash2 className="w-3 h-3" /></button>
                                                </div>
                                            </div>
                                        )))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showPinModal && <PinModal onClose={() => setShowPinModal(false)} onSuccess={handlePinSuccess} correctPin={parentPin} />}
                    {showCashOutModal && <CashOutModal onClose={() => setShowCashOutModal(false)} onConfirm={handleCashOut} currentBalance={Math.floor((childScores[cashOutChildId] || 0) / 5)} childName={getChildVisuals(cashOutChildId).name} />}
                    {showAddChildModal && <AddChildModal onClose={() => setShowAddChildModal(false)} onSave={handleAddChild} />}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Task App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #f8fafc; font-family: sans-serif; user-select: none; -webkit-user-select: none; }
        #root:empty::before { content: '×˜×•×¢×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”...'; display: block; text-align: center; margin-top: 50px; font-size: 24px; color: #64748b; }
        #crash-screen { display: none; position: fixed; inset: 0; background: #fee2e2; color: #991b1b; padding: 20px; z-index: 9999; overflow: auto; direction: ltr; text-align: left; }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="crash-screen"></div>
    <div id="root"></div>
    <script>window.onerror=function(m,u,l){document.getElementById('crash-screen').style.display='block';document.getElementById('crash-screen').innerHTML+=`<h3>âŒ Error:</h3><pre>${m}\nLine: ${l}</pre>`;}</script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment } from 'firebase/firestore';
        import * as LucideIcons from 'lucide-react';

        // --- KEYS ---
        const firebaseConfig = {
            apiKey: "AIzaSyCET42vMcj1uC0nMsqsWy2xd-yv1WC7e68",
            authDomain: "family-tasks-ee68f.firebaseapp.com",
            projectId: "family-tasks-ee68f",
            storageBucket: "family-tasks-ee68f.firebasestorage.app",
            messagingSenderId: "579816138584",
            appId: "1:579816138584:web:1b2a3cbf4c5fd00a45e72d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'family-app-main';
        const PARENT_PIN = "0613";

        // --- SOUND ENGINE (Synthesizer) ---
        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            
            if (type === 'ding') {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
                osc.frequency.exponentialRampToValueAtTime(1046.5, ctx.currentTime + 0.1); // C6
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start(); osc.stop(ctx.currentTime + 0.5);
            } else if (type === 'win') {
                const now = ctx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'triangle';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.2, now + i*0.15);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i*0.15 + 0.4);
                    osc.start(now + i*0.15); osc.stop(now + i*0.15 + 0.4);
                });
            }
        };

        // --- ICONS & HELPERS ---
        const getIcon = (name) => {
            const c = name.charAt(0).toUpperCase() + name.slice(1);
            return LucideIcons[c] || LucideIcons['Smile'];
        };

        const THEMES = [
            { id: 'pink', classes: 'bg-pink-100 text-pink-700 border-pink-300', iconBg: 'bg-pink-200', iconText: 'text-pink-600' },
            { id: 'blue', classes: 'bg-blue-100 text-blue-700 border-blue-300', iconBg: 'bg-blue-200', iconText: 'text-blue-600' },
            { id: 'green', classes: 'bg-green-100 text-green-700 border-green-300', iconBg: 'bg-green-200', iconText: 'text-green-600' },
            { id: 'purple', classes: 'bg-purple-100 text-purple-700 border-purple-300', iconBg: 'bg-purple-200', iconText: 'text-purple-600' },
            { id: 'yellow', classes: 'bg-yellow-100 text-yellow-700 border-yellow-300', iconBg: 'bg-yellow-200', iconText: 'text-yellow-600' },
            { id: 'orange', classes: 'bg-orange-100 text-orange-700 border-orange-300', iconBg: 'bg-orange-200', iconText: 'text-orange-600' },
            { id: 'teal', classes: 'bg-teal-100 text-teal-700 border-teal-300', iconBg: 'bg-teal-200', iconText: 'text-teal-600' },
            { id: 'red', classes: 'bg-red-100 text-red-700 border-red-300', iconBg: 'bg-red-200', iconText: 'text-red-600' },
        ];

        const CHILDREN_DEFAULTS = [
            { id: 'mushka', name: '×—×™×” ××•×©×§×', defaultThemeId: 'yellow', defaultIconKey: 'home', initialTasks: [{ id: 'def_mushka_1', text: '×¨×¦×¤×”', type: 'daily' }] },
            { id: 'dvora', name: '×“×‘×•×¨×” ×œ××”', defaultThemeId: 'pink', defaultIconKey: 'utensils', initialTasks: [{ id: 'def_dvora_1', text: '×›×œ×™× ×—×œ×‘×™ ×•×©×™×©', type: 'daily' }] },
            { id: 'rivka', name: '×¨×‘×§×”', defaultThemeId: 'purple', defaultIconKey: 'utensils', initialTasks: [{ id: 'def_rivka_1', text: '×œ×¤× ×•×ª ×©×•×œ×—×Ÿ', type: 'daily' }, { id: 'def_rivka_2', text: '×œ×¢×¨×•×š ×œ××¨×•×—×ª ×¢×¨×‘', type: 'daily' }] },
            { id: 'shmuel', name: '×©××•××œ', defaultThemeId: 'blue', defaultIconKey: 'shirt', initialTasks: [{ id: 'def_shmuel_1', text: '×œ×¤× ×•×ª ××ª ×”×¡×¤×”', type: 'daily' }, { id: 'def_shmuel_2', text: '×œ××¡×•×£ ×‘×’×“×™× ××œ×•×›×œ×›×™× ×œ×›×‘×™×¡×”', type: 'daily' }] },
            { id: 'pitzo', name: '×™×•×¡×£ ×™×¦×—×§', defaultThemeId: 'green', defaultIconKey: 'gamepad', initialTasks: [{ id: 'def_pitzo_1', text: '×œ××¡×•×£ ××©×—×§×™×', type: 'daily' }, { id: 'def_pitzo_2', text: '×œ××¡×•×£ × ×¢×œ×™×™×', type: 'daily' }] }
        ];

        const FAMILY_DEFAULT = { defaultThemeId: 'yellow', defaultIconKey: 'trophy', defaultTitle: '×”××‘×¦×¢ ×”××©×¤×—×ª×™', defaultTarget: 100 };

        const toHebrewNumeral = (n) => {
            if (!n || n < 1 || n > 31) return n;
            const letters = ['', '××³', '×‘×³', '×’×³', '×“×³', '×”×³', '×•×³', '×–×³', '×—×³', '×˜×³', '×™×³', '×™×´×', '×™×´×‘', '×™×´×’', '×™×´×“', '×˜×´×•', '×˜×´×–', '×™×´×–', '×™×´×—', '×™×´×˜', '×›×³', '×›×´×', '×›×´×‘', '×›×´×’', '×›×´×“', '×›×´×”', '×›×´×•', '×›×´×–', '×›×´×—', '×›×´×˜', '×œ×³', '×œ×´×'];
            return letters[n] || n;
        };

        const resizeImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 300, MAX_HEIGHT = 300;
                    let width = img.width, height = img.height;
                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } 
                    else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        function Confetti({ density = 150 }) {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current; if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const updateSize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
                updateSize(); window.addEventListener('resize', updateSize);
                const colors = ['#FCD34D', '#F87171', '#60A5FA', '#34D399', '#A78BFA', '#F472B6'];
                const particles = Array.from({ length: density }).map(() => ({
                    x: Math.random() * canvas.width, y: -Math.random() * canvas.height,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4, weight: Math.random() * 3 + 2,
                    angle: Math.random() * 360, spin: Math.random() * 5 - 2.5, oscillationSpeed: Math.random() * 0.05 + 0.02
                }));
                let animationId;
                function animate() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles.forEach(p => {
                        p.y += p.weight; p.angle += p.spin; p.x += Math.sin(p.angle * p.oscillationSpeed) * 2;
                        if (p.y > canvas.height) { p.y = -10; p.x = Math.random() * canvas.width; }
                        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle * Math.PI / 180);
                        ctx.fillStyle = p.color; ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size); ctx.restore();
                    });
                    animationId = requestAnimationFrame(animate);
                }
                animate(); return () => { cancelAnimationFrame(animationId); window.removeEventListener('resize', updateSize); };
            }, [density]);
            return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-[100]" />;
        }

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [points, setPoints] = useState(0);
            const [completedTasks, setCompletedTasks] = useState({});
            const [childSettings, setChildSettings] = useState({});
            const [familySettings, setFamilySettings] = useState({});
            const [tasksData, setTasksData] = useState({});
            const [historyData, setHistoryData] = useState([]);

            const [selectedChild, setSelectedChild] = useState(null);
            const [editingChildId, setEditingChildId] = useState(null);
            const [showFamilyEditModal, setShowFamilyEditModal] = useState(false);
            const [showBonusModal, setShowBonusModal] = useState(false);
            const [showWinModal, setShowWinModal] = useState(false);
            const [showPinModal, setShowPinModal] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            
            const [animationClass, setAnimationClass] = useState('');
            const [showConfetti, setShowConfetti] = useState(false);
            const confettiTimeoutRef = useRef(null);
            const pinCallback = useRef(null);

            const [currentDate, setCurrentDate] = useState('');
            const [hebrewDate, setHebrewDate] = useState('');
            const targetPoints = familySettings.targetPoints || FAMILY_DEFAULT.defaultTarget;

            const longPressTimer = useRef(null);
            const isLongPress = useRef(false);
            const createLongPressHandlers = (callback, onClick) => ({
                onMouseDown: () => { isLongPress.current = false; longPressTimer.current = setTimeout(() => { isLongPress.current = true; callback(); }, 800); },
                onMouseUp: (e) => { if (longPressTimer.current) clearTimeout(longPressTimer.current); if (!isLongPress.current && onClick) onClick(e); },
                onMouseLeave: () => { if (longPressTimer.current) clearTimeout(longPressTimer.current); },
                onTouchStart: () => { isLongPress.current = false; longPressTimer.current = setTimeout(() => { isLongPress.current = true; callback(); }, 800); },
                onTouchEnd: (e) => { if (longPressTimer.current) clearTimeout(longPressTimer.current); if (isLongPress.current) e.preventDefault(); if (!isLongPress.current && onClick) onClick(e); }
            });

            useEffect(() => {
                signInAnonymously(auth);
                onAuthStateChanged(auth, setUser);
                const now = new Date();
                setCurrentDate(now.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' }));
                try {
                    const p = new Intl.DateTimeFormat('he-IL', { calendar: 'hebrew', day: 'numeric', month: 'long', year: 'numeric' }).formatToParts(now);
                    const d = p.find(x => x.type === 'day')?.value; const m = p.find(x => x.type === 'month')?.value; const y = p.find(x => x.type === 'year')?.value;
                    if (d && m && y) setHebrewDate(`${toHebrewNumeral(parseInt(d))} ${m} ${y}`);
                } catch(e){}
            }, []);

            useEffect(() => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');
                return onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        setPoints(Number(d.points) || 0);
                        setCompletedTasks(d.completedTasks || {});
                        setChildSettings(d.childSettings || {});
                        setFamilySettings(d.familySettings || {});
                        setTasksData(d.childTasks || {});
                        setHistoryData(d.history || []);
                    } else {
                        setDoc(docRef, { points: 0, completedTasks: {}, childSettings: {}, familySettings: {}, childTasks: {}, history: [] });
                    }
                });
            }, [user]);

            useEffect(() => { 
                if (points >= targetPoints && points > 0) {
                    if (!showWinModal) playSound('win'); 
                    setShowWinModal(true); 
                } 
            }, [points, targetPoints]);

            const getTodayKey = () => { const d = new Date(); return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`; };
            
            const getChildVisuals = (childId) => {
                const def = CHILDREN_DEFAULTS.find(c => c.id === childId);
                const s = childSettings[childId] || {};
                const theme = THEMES.find(t => t.id === (s.themeId || def.defaultThemeId)) || THEMES[0];
                const Icon = getIcon(s.iconKey || def.defaultIconKey);
                return { ...s, theme, IconComponent: Icon, name: s.name || def.name, emoji: s.emoji || 'ğŸ˜Š' };
            };

            const getChildTasks = (childId) => {
                if (tasksData[childId]) {
                    const today = getTodayKey(); const day = new Date().getDay(); 
                    return tasksData[childId].filter(t => t.type === 'daily' || (t.type === 'one-time' && t.date === today) || (t.type === 'friday' && day === 5));
                }
                return CHILDREN_DEFAULTS.find(c => c.id === childId)?.initialTasks || [];
            };

            const triggerConfetti = () => {
                setAnimationClass('scale-110'); setTimeout(() => setAnimationClass(''), 200);
                setShowConfetti(true); if (confettiTimeoutRef.current) clearTimeout(confettiTimeoutRef.current);
                confettiTimeoutRef.current = setTimeout(() => setShowConfetti(false), 3000); 
            };

            // --- PROTECTED ACTIONS ---
            const requestPin = (callback) => {
                pinCallback.current = callback;
                setShowPinModal(true);
            };

            const handleTaskToggle = async (childId, taskId, taskText) => {
                if (!user) return;
                const key = `${getTodayKey()}_${childId}_${taskId}`;
                const isDone = completedTasks[key];
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');
                
                if (!isDone) {
                    triggerConfetti();
                    playSound('ding');
                    const newHistoryItem = { id: Date.now().toString(), childId, task: taskText, timestamp: Date.now(), key, points: 1 };
                    await updateDoc(docRef, { 
                        points: increment(1), 
                        [`completedTasks.${key}`]: true,
                        history: [newHistoryItem, ...historyData]
                    });
                } else {
                    await updateDoc(docRef, { points: increment(-1), [`completedTasks.${key}`]: false });
                }
            };

            const handleDeleteHistoryItem = async (item) => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status');
                const updates = {
                    points: increment(-item.points),
                    history: historyData.filter(h => h.id !== item.id)
                };
                if (item.key) { updates[`completedTasks.${item.key}`] = false; }
                await updateDoc(docRef, updates);
            };

            const handleSaveFamilySettings = async (s) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status'), { familySettings: s });
                setShowFamilyEditModal(false);
            };

            const progressPercent = Math.min((points / targetPoints) * 100, 100);
            const fam = (() => {
                const s = familySettings || {};
                const theme = THEMES.find(t => t.id === (s.themeId || FAMILY_DEFAULT.defaultThemeId)) || THEMES[0];
                const Icon = getIcon(s.iconKey || FAMILY_DEFAULT.defaultIconKey);
                return { ...s, theme, IconComponent: Icon, title: s.title || FAMILY_DEFAULT.defaultTitle, emoji: s.emoji || 'ğŸ†' };
            })();

            const SettingsIcon = getIcon('Settings');
            const PlusIcon = getIcon('Plus');
            const SparklesIcon = getIcon('Sparkles');
            const TrophyIcon = getIcon('Trophy');
            const RotateCcwIcon = getIcon('RotateCcw');
            const XIcon = getIcon('X');
            const CheckIcon = getIcon('Check');
            const TrashIcon = getIcon('Trash2');
            const StarIcon = getIcon('Star');
            const CalendarIcon = getIcon('Calendar');
            const RepeatIcon = getIcon('Repeat');
            const CalendarDaysIcon = getIcon('CalendarDays');
            const TypeIcon = getIcon('Type');
            const PaletteIcon = getIcon('Palette');
            const SmileIcon = getIcon('Smile');
            const CameraIcon = getIcon('Camera');
            const ImageIconIcon = getIcon('Image');
            const MinusIcon = getIcon('Minus');
            const TargetIcon = getIcon('Target');
            const LockIcon = getIcon('Lock');
            const HistoryIcon = getIcon('History');

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800" dir="rtl">
                    {(showConfetti || showWinModal) && <Confetti density={showWinModal ? 400 : 150} />}

                    <header className="bg-white shadow-lg p-6 sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-3 select-none">
                                <div className={`p-3 rounded-full cursor-pointer transition-transform active:scale-95 ${fam.theme.classes.split(' ')[0]} ${fam.theme.classes.split(' ')[2].replace('border', 'border-2')}`} 
                                     {...createLongPressHandlers(() => requestPin(() => setShowFamilyEditModal(true)))}>
                                    <div className="w-8 h-8 flex items-center justify-center overflow-hidden rounded-full">
                                        {fam.useImage && fam.image ? <img src={fam.image} className="w-full h-full object-cover"/> : fam.useEmoji ? <span className="text-2xl leading-none">{fam.emoji}</span> : <fam.IconComponent className={`w-8 h-8 ${fam.theme.iconText}`} />}
                                    </div>
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-800 cursor-pointer" {...createLongPressHandlers(() => requestPin(() => setShowFamilyEditModal(true)))}>{fam.title}</h1>
                                    <div className="text-slate-500 text-sm flex gap-2"><span>{currentDate}</span>{hebrewDate && <span className="border-r border-slate-300 pr-2">{hebrewDate}</span>}</div>
                                </div>
                            </div>
                            <div className="flex-1 w-full md:w-auto md:mx-8 cursor-pointer group" onClick={() => setShowHistoryModal(true)}>
                                <div className="flex justify-between mb-2 text-lg font-bold">
                                    <span className={`transition-transform duration-300 ${animationClass} text-blue-600 flex items-center gap-2`}>
                                        {points} × ×§×•×“×•×ª
                                        <HistoryIcon className="w-4 h-4 text-slate-300 group-hover:text-blue-400 transition-colors" />
                                    </span>
                                    <span className="text-slate-400">×™×¢×“: {targetPoints}</span>
                                </div>
                                <div className="h-6 w-full bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                    <div className="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-700 ease-out flex items-center justify-center relative" style={{ width: `${progressPercent}%` }}>
                                        {progressPercent > 10 && <div className="absolute left-0 top-0 bottom-0 w-full animate-[shimmer_2s_infinite] bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12"></div>}
                                    </div>
                                </div>
                            </div>
                            <button onClick={() => setShowBonusModal(true)} className="flex items-center gap-2 bg-gradient-to-r from-orange-400 to-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:shadow-lg transform active:scale-95 transition-all"><SparklesIcon className="w-5 h-5" /><span>×‘×•× ×•×¡</span></button>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-6">
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mt-4">
                            {CHILDREN_DEFAULTS.map((child) => {
                                const v = getChildVisuals(child.id);
                                const tasks = getChildTasks(child.id);
                                return (
                                    <div key={child.id} className={`group relative bg-white rounded-3xl p-6 border-4 ${v.theme.classes.split(' ')[2]} shadow-md hover:shadow-xl hover:-translate-y-2 transition-all duration-300 flex flex-col items-center justify-center gap-4 h-64 select-none`}
                                        {...createLongPressHandlers(() => requestPin(() => setEditingChildId(child.id)), () => setSelectedChild(child))}>
                                        <button onClick={(e) => { e.stopPropagation(); requestPin(() => setEditingChildId(child.id)); }} className="absolute top-2 right-2 p-2 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity"><SettingsIcon className="w-4 h-4" /></button>
                                        <div className={`w-24 h-24 rounded-full ${v.theme.iconBg} flex items-center justify-center shadow-inner group-hover:scale-110 transition-transform overflow-hidden`}>
                                            {v.useImage && v.image ? <img src={v.image} className="w-full h-full object-cover"/> : v.useEmoji ? <span className="text-5xl leading-none">{v.emoji}</span> : <v.IconComponent className={`w-10 h-10 ${v.theme.iconText}`} />}
                                        </div>
                                        <h2 className="text-2xl font-bold text-center mt-4">{v.name}</h2>
                                        <div className="flex gap-1 mt-2">{tasks.map(t => <div key={t.id} className={`w-3 h-3 rounded-full ${completedTasks[`${getTodayKey()}_${child.id}_${t.id}`] ? 'bg-green-500' : 'bg-slate-200'}`} />)}</div>
                                        <div className="absolute top-4 left-4 bg-slate-100 rounded-full p-1 opacity-0 group-hover:opacity-100 pointer-events-none"><PlusIcon className="w-5 h-5 text-slate-400" /></div>
                                    </div>
                                );
                            })}
                        </div>
                    </main>

                    {selectedChild && <TaskModal child={selectedChild} tasks={getChildTasks(selectedChild.id)} completedTasks={completedTasks} visuals={getChildVisuals(selectedChild.id)} onToggleTask={handleTaskToggle} onClose={() => setSelectedChild(null)} onAddTask={(cid, txt, type) => {
                        const newT = { id: `custom_${Date.now()}`, text: txt, type, date: getTodayKey() };
                        updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status'), { childTasks: { ...tasksData, [cid]: [...getChildTasks(cid), newT] } });
                    }} onDeleteTask={(cid, tid) => {
                        requestPin(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status'), { childTasks: { ...tasksData, [cid]: getChildTasks(cid).filter(t => t.id !== tid) } }));
                    }} getTodayKey={getTodayKey} icons={{XIcon, CheckIcon, TrashIcon, CalendarIcon, RepeatIcon, CalendarDaysIcon, StarIcon, PlusIcon}} />}
                    
                    {editingChildId && <EditChildModal childId={editingChildId} initialSettings={getChildVisuals(editingChildId)} currentSettings={childSettings[editingChildId] || {}} onClose={() => setEditingChildId(null)} onSave={async (cid, s) => {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status'), { childSettings: { ...childSettings, [cid]: { ...childSettings[cid], ...s } } });
                        setEditingChildId(null);
                    }} icons={{XIcon, TypeIcon, PaletteIcon, CheckIcon, SmileIcon, CameraIcon, ImageIconIcon}} getIcon={getIcon} />}

                    {showFamilyEditModal && <EditFamilyModal initialSettings={fam} currentSettings={familySettings} onClose={() => setShowFamilyEditModal(false)} onSave={handleSaveFamilySettings} icons={{XIcon, TypeIcon, TargetIcon, PaletteIcon, CheckIcon, SmileIcon, CameraIcon, ImageIconIcon}} getIcon={getIcon} />}

                    {showBonusModal && <BonusModal onClose={() => setShowBonusModal(false)} onConfirm={async (amt) => { 
                        triggerConfetti(); playSound('ding');
                        const newHistoryItem = { id: Date.now().toString(), childId: 'family', task: '×‘×•× ×•×¡ ××©×¤×—×ª×™', timestamp: Date.now(), points: amt };
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status'), { 
                            points: increment(amt), history: [newHistoryItem, ...historyData]
                        }); 
                        setShowBonusModal(false); 
                    }} icons={{SparklesIcon, MinusIcon, PlusIcon}} />}

                    {showHistoryModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><HistoryIcon className="w-5 h-5"/> ×”×™×¡×˜×•×¨×™×™×ª × ×§×•×“×•×ª</h3>
                                    <button onClick={() => setShowHistoryModal(false)} className="p-2 hover:bg-slate-200 rounded-full"><XIcon className="w-5 h-5" /></button>
                                </div>
                                <div className="p-4 overflow-y-auto flex-1 bg-slate-50 space-y-3">
                                    {historyData.length === 0 ? <p className="text-center text-slate-400 mt-10">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×¢×“×™×™×Ÿ...</p> : 
                                    historyData.map(item => {
                                        const v = item.childId === 'family' ? fam : getChildVisuals(item.childId);
                                        return (
                                            <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-100 flex items-center justify-between shadow-sm">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${v.theme.iconBg} text-lg`}>
                                                        {v.useImage ? <img src={v.image} className="w-full h-full object-cover rounded-full"/> : v.useEmoji ? v.emoji : <v.IconComponent className={`w-5 h-5 ${v.theme.iconText}`}/>}
                                                    </div>
                                                    <div>
                                                        <p className="font-bold text-slate-800">{v.name || v.title}</p>
                                                        <p className="text-sm text-slate-500">{item.task}</p>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="font-bold text-green-600">+{item.points}</span>
                                                    <button onClick={() => requestPin(() => handleDeleteHistoryItem(item))} className="p-2 bg-red-50 text-red-500 rounded-full hover:bg-red-100"><TrashIcon className="w-4 h-4" /></button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {showPinModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 text-center">
                                <div className="mx-auto w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4"><LockIcon className="w-8 h-8 text-slate-500" /></div>
                                <h3 className="text-2xl font-bold text-slate-800 mb-6">×‘×“×™×§×ª ×”×•×¨×™×</h3>
                                <div className="grid grid-cols-3 gap-4 mb-6" dir="ltr">
                                    {[1,2,3,4,5,6,7,8,9].map(n => <button key={n} onClick={() => { 
                                        const input = document.getElementById('pin-input'); 
                                        input.value += n; 
                                        if (input.value === PARENT_PIN) { setShowPinModal(false); pinCallback.current(); input.value = ''; }
                                        if (input.value.length >= 4 && input.value !== PARENT_PIN) { input.classList.add('animate-pulse', 'bg-red-100'); setTimeout(()=> { input.value=''; input.classList.remove('animate-pulse', 'bg-red-100'); }, 300); }
                                    }} className="aspect-square rounded-2xl bg-slate-50 text-2xl font-bold text-slate-700 hover:bg-slate-200 active:scale-95 transition-all tap-highlight-transparent">{n}</button>)}
                                    <div className="aspect-square"></div>
                                    <button onClick={() => {
                                        const input = document.getElementById('pin-input');
                                        input.value += 0;
                                        if (input.value === PARENT_PIN) { setShowPinModal(false); pinCallback.current(); input.value = ''; }
                                    }} className="aspect-square rounded-2xl bg-slate-50 text-2xl font-bold text-slate-700 hover:bg-slate-200 active:scale-95 transition-all tap-highlight-transparent">0</button>
                                </div>
                                <input id="pin-input" type="password" className="w-full text-center text-3xl tracking-widest font-bold border-b-2 border-slate-200 outline-none pb-2 bg-transparent" readOnly />
                                <button onClick={() => setShowPinModal(false)} className="mt-6 text-slate-400 font-bold hover:text-slate-600">×‘×™×˜×•×œ</button>
                            </div>
                        </div>
                    )}

                    {showWinModal && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md animate-fade-in">
                            <div className="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl p-8 text-center animate-scale-up border-8 border-yellow-300 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-32 bg-yellow-100 rounded-b-[50%] -translate-y-16"></div>
                                <div className="relative z-10">
                                    <div className="mx-auto w-32 h-32 bg-gradient-to-b from-yellow-300 to-yellow-500 rounded-full flex items-center justify-center mb-6 shadow-xl border-4 border-white animate-bounce"><TrophyIcon className="w-16 h-16 text-white drop-shadow-md" /></div>
                                    <h2 className="text-5xl font-black text-slate-800 mb-2">×›×œ ×”×›×‘×•×“!</h2>
                                    <h3 className="text-2xl font-bold text-slate-600 mb-6">×”×’×¢×ª× ×œ×™×¢×“ ×©×œ {targetPoints} × ×§×•×“×•×ª!</h3>
                                    <button onClick={() => requestPin(async () => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_project_v1', 'status'), { points: 0, history: [] }); setShowWinModal(false); })} className="w-full py-4 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold text-xl shadow-xl flex items-center justify-center gap-2"><RotateCcwIcon className="w-6 h-6"/>××¤×¡ × ×§×•×“×•×ª ×•×”×ª×—×œ ××—×“×©</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <style>{`@keyframes shimmer { 0% { transform: translateX(-150%); } 50% { transform: translateX(150%); } 100% { transform: translateX(150%); } } @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } } @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } } @keyframes scale-up { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-fade-in { animation: fade-in 0.2s ease-out; } .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); } .animate-scale-up { animation: scale-up 0.2s cubic-bezier(0.16, 1, 0.3, 1); }`}</style>
                </div>
            );
        }

        // --- SUB COMPONENTS ---
        function BonusModal({ onClose, onConfirm, icons }) {
            const [amount, setAmount] = useState(1);
            const { SparklesIcon, MinusIcon, PlusIcon } = icons;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 text-center animate-scale-up">
                        <div className="mx-auto w-16 h-16 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center mb-4 shadow-lg"><SparklesIcon className="w-8 h-8 text-white" /></div>
                        <h3 className="text-2xl font-bold text-slate-800 mb-2">×”×•×¡×¤×ª ×‘×•× ×•×¡</h3>
                        <div className="flex items-center justify-center gap-4 mb-8">
                            <button onClick={() => setAmount(Math.max(1, amount - 1))} className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center"><MinusIcon className="w-6 h-6" /></button>
                            <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 w-24 tabular-nums">{amount}</div>
                            <button onClick={() => setAmount(Math.min(10, amount + 1))} className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center"><PlusIcon className="w-6 h-6" /></button>
                        </div>
                        <div className="flex gap-4 justify-center"><button onClick={onClose} className="px-6 py-3 rounded-xl border-2 border-slate-200">×‘×™×˜×•×œ</button><button onClick={() => onConfirm(amount)} className="px-8 py-3 rounded-xl bg-gradient-to-r from-orange-400 to-red-500 text-white font-bold">×”×•×¡×£!</button></div>
                    </div>
                </div>
            );
        }

        function TaskModal({ child, tasks, completedTasks, visuals, onToggleTask, onClose, onAddTask, onDeleteTask, getTodayKey, icons }) {
            const { theme, IconComponent, useEmoji, emoji, useImage, image, name } = visuals;
            const { XIcon, CheckIcon, TrashIcon, CalendarIcon, RepeatIcon, CalendarDaysIcon, StarIcon, PlusIcon } = icons;
            const [isAdding, setIsAdding] = useState(false);
            const [newTaskText, setNewTaskText] = useState("");
            const [newTaskType, setNewTaskType] = useState("daily");
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[90vh]" onClick={(e) => e.stopPropagation()}>
                        <div className={`${theme.iconBg} p-6 flex items-center justify-between flex-shrink-0`}>
                            <div className="flex items-center gap-4">
                                <div className="bg-white/50 p-1 rounded-full flex items-center justify-center w-16 h-16 overflow-hidden border-2 border-white/50">{useImage && image ? <img src={image} className="w-full h-full object-cover rounded-full" /> : useEmoji ? <span className="text-3xl">{emoji}</span> : <IconComponent className={`w-8 h-8 ${theme.iconText}`} />}</div>
                                <div><h2 className="text-3xl font-bold text-slate-800">{name}</h2><p className="text-slate-600 text-lg">×”××©×™××•×ª ×œ×”×™×•×</p></div>
                            </div>
                            <button onClick={onClose} className="bg-white/50 p-2 rounded-full"><XIcon className="w-6 h-6 text-slate-700" /></button>
                        </div>
                        <div className="p-8 space-y-4 overflow-y-auto flex-1">
                            {tasks.map((task) => {
                                const isDone = completedTasks[`${getTodayKey()}_${child.id}_${task.id}`];
                                return (
                                    <div key={task.id} className="relative group">
                                        <button onClick={() => onToggleTask(child.id, task.id, task.text)} className={`w-full flex items-center justify-between p-5 rounded-2xl border-2 transition-all duration-200 ${isDone ? 'bg-green-50 border-green-200 shadow-none' : 'bg-white border-slate-100 shadow-md'}`}>
                                            <div className="flex items-center gap-3">{task.type==='one-time'?<CalendarIcon className="w-4 h-4 text-blue-400"/>:task.type==='daily'?<RepeatIcon className="w-4 h-4 text-purple-400"/>:<CalendarDaysIcon className="w-4 h-4 text-pink-400"/>}<span className={`text-xl font-medium ${isDone ? 'text-green-800 line-through opacity-70' : 'text-slate-700'}`}>{task.text}</span></div>
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all ${isDone ? 'bg-green-500 border-green-500 scale-110' : 'bg-white border-slate-300'}`}>{isDone && <CheckIcon className="w-6 h-6 text-white" />}</div>
                                        </button>
                                        <button onClick={(e) => { e.stopPropagation(); onDeleteTask(child.id, task.id); }} className="absolute -left-2 top-1/2 -translate-y-1/2 -translate-x-full p-2 bg-red-100 text-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"><TrashIcon className="w-5 h-5" /></button>
                                    </div>
                                );
                            })}
                            {tasks.length > 0 && tasks.every((t) => completedTasks[`${getTodayKey()}_${child.id}_${t.id}`]) && <div className="mt-6 text-center bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-yellow-800 animate-pulse"><StarIcon className="w-8 h-8 mx-auto mb-2 text-yellow-500 fill-yellow-500" /><p className="font-bold text-lg">×›×œ ×”×›×‘×•×“! ×¡×™×™××ª ××ª ×›×œ ×”××©×™××•×ª ×œ×”×™×•×!</p></div>}
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50">
                            {!isAdding ? <button onClick={() => setIsAdding(true)} className="w-full py-3 rounded-xl border-2 border-dashed border-slate-300 text-slate-500 font-bold hover:bg-white flex items-center justify-center gap-2"><PlusIcon className="w-5 h-5" />×”×•×¡×£ ××©×™××” ×—×“×©×”</button> : 
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm animate-fade-in">
                                <input type="text" placeholder="×©× ×”××©×™××”..." value={newTaskText} onChange={(e) => setNewTaskText(e.target.value)} className="w-full p-3 rounded-lg border border-slate-300 mb-3" autoFocus />
                                <div className="flex gap-2 mb-3">
                                    <button onClick={() => setNewTaskType('daily')} className={`flex-1 py-2 rounded-lg text-sm font-bold border ${newTaskType==='daily'?'bg-purple-100 text-purple-700 border-purple-300':'bg-slate-50 border-slate-200'}`}>×›×œ ×™×•×</button>
                                    <button onClick={() => setNewTaskType('friday')} className={`flex-1 py-2 rounded-lg text-sm font-bold border ${newTaskType==='friday'?'bg-pink-100 text-pink-700 border-pink-300':'bg-slate-50 border-slate-200'}`}>×™×•× ×©×™×©×™</button>
                                    <button onClick={() => setNewTaskType('one-time')} className={`flex-1 py-2 rounded-lg text-sm font-bold border ${newTaskType==='one-time'?'bg-blue-100 text-blue-700 border-blue-300':'bg-slate-50 border-slate-200'}`}>×¨×§ ×œ×”×™×•×</button>
                                </div>
                                <div className="flex gap-2"><button onClick={() => setIsAdding(false)} className="flex-1 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg">×‘×™×˜×•×œ</button><button onClick={() => { if(!newTaskText.trim())return; onAddTask(child.id, newTaskText, newTaskType); setNewTaskText(""); setIsAdding(false); }} className="flex-1 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md">×©××•×¨</button></div>
                            </div>}
                        </div>
                    </div>
                </div>
            );
        }

        function EditChildModal({ childId, initialSettings, currentSettings, onClose, onSave, icons, getIcon }) {
            const { XIcon, TypeIcon, PaletteIcon, CheckIcon, SmileIcon, CameraIcon, ImageIconIcon } = icons;
            const [activeTab, setActiveTab] = useState(currentSettings.useImage ? 'image' : currentSettings.useEmoji ? 'emoji' : 'icon');
            const [selectedThemeId, setSelectedThemeId] = useState(currentSettings.themeId || initialSettings.theme.id);
            const [selectedIconKey, setSelectedIconKey] = useState(currentSettings.iconKey || 'smile');
            const [customEmoji, setCustomEmoji] = useState(currentSettings.emoji || 'ğŸ˜Š');
            const [customImage, setCustomImage] = useState(currentSettings.image || null);
            const [customName, setCustomName] = useState(currentSettings.name || initialSettings.name);
            const [isProcessing, setIsProcessing] = useState(false);
            const ICON_KEYS = ['trophy', 'utensils', 'shirt', 'gamepad', 'home', 'star', 'heart', 'smile', 'sun', 'moon', 'music', 'book', 'bike', 'car', 'cat', 'dog', 'flower', 'camera', 'sparkles'];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 className="text-xl font-bold text-slate-800">×¢×¨×™×›×ª ×¤×¨×˜×™ ×™×œ×“</h3><button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><XIcon className="w-5 h-5" /></button></div>
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="mb-6"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><TypeIcon className="w-5 h-5 text-slate-500" />×©× ×”×™×œ×“</h4><input type="text" value={customName} onChange={(e) => setCustomName(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 text-lg" /></div>
                            <div className="mb-8"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><PaletteIcon className="w-5 h-5 text-purple-500" />×‘×—×¨ ×¦×‘×¢</h4><div className="flex flex-wrap gap-3">{THEMES.map(t => <button key={t.id} onClick={() => setSelectedThemeId(t.id)} className={`w-10 h-10 rounded-full border-2 flex items-center justify-center ${t.classes.split(' ')[0]} ${selectedThemeId === t.id ? 'border-slate-800 scale-110 shadow-md ring-2' : 'border-transparent'}`}>{selectedThemeId === t.id && <CheckIcon className={`w-5 h-5 ${t.classes.split(' ')[1]}`} />}</button>)}</div></div>
                            <div>
                                <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><SmileIcon className="w-5 h-5 text-orange-500" />×¡××œ / ×ª××•× ×”</h4>
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-4"><button onClick={() => setActiveTab('icon')} className={`flex-1 py-2 rounded-lg font-medium ${activeTab==='icon'?'bg-white shadow':''}`}>×¡××œ×™×</button><button onClick={() => setActiveTab('emoji')} className={`flex-1 py-2 rounded-lg font-medium ${activeTab==='emoji'?'bg-white shadow':''}`}>××™××•×’'×™</button><button onClick={() => setActiveTab('image')} className={`flex-1 py-2 rounded-lg font-medium ${activeTab==='image'?'bg-white shadow':''}`}>×ª××•× ×”</button></div>
                                {activeTab === 'icon' && <div className="grid grid-cols-5 gap-3">{ICON_KEYS.map((k) => { const I = getIcon(k); return <button key={k} onClick={() => setSelectedIconKey(k)} className={`aspect-square rounded-xl flex items-center justify-center border-2 ${selectedIconKey === k ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-slate-200'}`}><I className="w-6 h-6" /></button>; })}</div>}
                                {activeTab === 'emoji' && <div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200"><input type="text" value={customEmoji} onChange={(e) => setCustomEmoji(e.target.value)} className="w-24 h-24 text-center text-6xl rounded-2xl border-2 border-slate-300" maxLength={2} /></div>}
                                {activeTab === 'image' && <div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200"><div className="relative w-32 h-32 mb-4 group cursor-pointer">{customImage ? <img src={customImage} className="w-full h-full object-cover rounded-full border-4 border-white shadow-md"/> : <div className="w-full h-full rounded-full bg-slate-200 flex items-center justify-center border-4 border-white"><ImageIconIcon className="w-10 h-10 text-slate-400"/></div>}<input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={async(e)=>{ if(e.target.files[0]){ setIsProcessing(true); setCustomImage(await resizeImage(e.target.files[0])); setIsProcessing(false); }}} /></div>{isProcessing ? <p className="text-blue-500">××¢×‘×“...</p> : <p className="text-sm">×œ×—×¥ ×œ×‘×—×™×¨×ª ×ª××•× ×”</p>}</div>}
                            </div>
                        </div>
                        <div className="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3"><button onClick={onClose} className="px-5 py-2.5 rounded-xl font-bold text-slate-500">×‘×™×˜×•×œ</button><button onClick={() => onSave(childId, { themeId: selectedThemeId, useEmoji: activeTab === 'emoji', useImage: activeTab === 'image', iconKey: selectedIconKey, emoji: customEmoji, image: customImage, name: customName })} className="px-8 py-2.5 rounded-xl font-bold text-white bg-blue-600 shadow-lg">×©××•×¨</button></div>
                    </div>
                </div>
            );
        }

        function EditFamilyModal({ initialSettings, currentSettings, onClose, onSave, icons, getIcon }) {
            const { XIcon, TypeIcon, TargetIcon, PaletteIcon, CheckIcon, SmileIcon, CameraIcon, ImageIconIcon } = icons;
            const [activeTab, setActiveTab] = useState(currentSettings.useImage ? 'image' : currentSettings.useEmoji ? 'emoji' : 'icon');
            const [selectedThemeId, setSelectedThemeId] = useState(currentSettings.themeId || initialSettings.theme.id);
            const [selectedIconKey, setSelectedIconKey] = useState(currentSettings.iconKey || 'trophy');
            const [customEmoji, setCustomEmoji] = useState(currentSettings.emoji || 'ğŸ†');
            const [customImage, setCustomImage] = useState(currentSettings.image || null);
            const [customTitle, setCustomTitle] = useState(currentSettings.title || initialSettings.title);
            const [customTarget, setCustomTarget] = useState(currentSettings.targetPoints || 100);
            const [isProcessing, setIsProcessing] = useState(false);
            const ICON_KEYS = ['trophy', 'utensils', 'shirt', 'gamepad', 'home', 'star', 'heart', 'smile', 'sun', 'moon', 'music', 'book', 'bike', 'car', 'cat', 'dog', 'flower', 'camera', 'sparkles'];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 className="text-xl font-bold text-slate-800">×¢×¨×™×›×ª ×›×•×ª×¨×ª ×•×¡××œ</h3><button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><XIcon className="w-5 h-5" /></button></div>
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="mb-6"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><TypeIcon className="w-5 h-5 text-slate-500" />×›×•×ª×¨×ª</h4><input type="text" value={customTitle} onChange={(e) => setCustomTitle(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 text-lg" /></div>
                            <div className="mb-6"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><TargetIcon className="w-5 h-5 text-slate-500" />×™×¢×“ × ×§×•×“×•×ª</h4><input type="number" value={customTarget} onChange={(e) => setCustomTarget(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 text-lg" /></div>
                            <div className="mb-8"><h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><PaletteIcon className="w-5 h-5 text-purple-500" />×¦×‘×¢</h4><div className="flex flex-wrap gap-3">{THEMES.map(t => <button key={t.id} onClick={() => setSelectedThemeId(t.id)} className={`w-10 h-10 rounded-full border-2 flex items-center justify-center ${t.classes.split(' ')[0]} ${selectedThemeId === t.id ? 'border-slate-800 scale-110 shadow-md ring-2' : 'border-transparent'}`}>{selectedThemeId === t.id && <CheckIcon className={`w-5 h-5 ${t.classes.split(' ')[1]}`} />}</button>)}</div></div>
                            <div>
                                <h4 className="flex items-center gap-2 font-bold text-slate-700 mb-3"><SmileIcon className="w-5 h-5 text-orange-500" />×¡××œ</h4>
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-4"><button onClick={() => setActiveTab('icon')} className={`flex-1 py-2 rounded-lg font-medium ${activeTab==='icon'?'bg-white shadow':''}`}>×¡××œ×™×</button><button onClick={() => setActiveTab('emoji')} className={`flex-1 py-2 rounded-lg font-medium ${activeTab==='emoji'?'bg-white shadow':''}`}>××™××•×’'×™</button><button onClick={() => setActiveTab('image')} className={`flex-1 py-2 rounded-lg font-medium ${activeTab==='image'?'bg-white shadow':''}`}>×ª××•× ×”</button></div>
                                {activeTab === 'icon' && <div className="grid grid-cols-5 gap-3">{ICON_KEYS.map((k) => { const I = getIcon(k); return <button key={k} onClick={() => setSelectedIconKey(k)} className={`aspect-square rounded-xl flex items-center justify-center border-2 ${selectedIconKey === k ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-slate-200'}`}><I className="w-6 h-6" /></button>; })}</div>}
                                {activeTab === 'emoji' && <div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200"><input type="text" value={customEmoji} onChange={(e) => setCustomEmoji(e.target.value)} className="w-24 h-24 text-center text-6xl rounded-2xl border-2 border-slate-300" maxLength={2} /></div>}
                                {activeTab === 'image' && <div className="flex flex-col items-center p-4 bg-slate-50 rounded-xl border border-slate-200"><div className="relative w-32 h-32 mb-4 group cursor-pointer">{customImage ? <img src={customImage} className="w-full h-full object-cover rounded-full border-4 border-white shadow-md"/> : <div className="w-full h-full rounded-full bg-slate-200 flex items-center justify-center border-4 border-white"><ImageIconIcon className="w-10 h-10 text-slate-400"/></div>}<input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={async(e)=>{ if(e.target.files[0]){ setIsProcessing(true); setCustomImage(await resizeImage(e.target.files[0])); setIsProcessing(false); }}} /></div>{isProcessing ? <p className="text-blue-500">××¢×‘×“...</p> : <p className="text-sm">×œ×—×¥ ×œ×‘×—×™×¨×ª ×ª××•× ×”</p>}</div>}
                            </div>
                        </div>
                        <div className="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3"><button onClick={onClose} className="px-5 py-2.5 rounded-xl font-bold text-slate-500">×‘×™×˜×•×œ</button><button onClick={() => onSave({ themeId: selectedThemeId, useEmoji: activeTab === 'emoji', useImage: activeTab === 'image', iconKey: selectedIconKey, emoji: customEmoji, image: customImage, title: customTitle, targetPoints: Number(customTarget) })} className="px-8 py-2.5 rounded-xl font-bold text-white bg-blue-600 shadow-lg">×©××•×¨</button></div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
